--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

MoonshineDistillery = MoonshineDistillery or {}
-----------------------            ---------------------------

function MoonshineDistillery.findCookingVat()
   local rad = 8
   local pl = getPlayer()
   local sq = pl:getCurrentSquare()
   local cell = getCell()
   local x, y, z = sq:getX(), sq:getY(), sq:getZ()
   for xDelta = -rad, rad do
      for yDelta = -rad, rad do
         local sq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
         for i = 0, sq:getObjects():size() - 1 do
            local obj = sq:getObjects():get(i)
            if obj and obj:getSprite() then
               local sprName = obj:getSprite():getName()
               if sprName and MoonshineDistillery.isCookingVat(sprName) then
                  return obj
               end
            end
         end
      end
   end
   return nil
end



-----------------------   cookingVat*        ---------------------------
function MoonshineDistillery.contextCV(player, context, worldobjects, test)
   local pl = getSpecificPlayer(player)
   local inv = pl:getInventory()
   local pr = pl:getPrimaryHandItem()
   local sq = clickedSquare
   if not MoonshineDistillery.isLearned(pl) then return end
   if not sq then return end
   local checkDist = MoonshineDistillery.checkDist(pl, sq)

   local isCampfire = false
   local campfire = nil

   for i = 0, sq:getObjects():size() - 1 do
      local obj = sq:getObjects():get(i)
      local spr = obj:getSprite()
      local sprName = spr and spr:getName()

      if sprName then
         if MoonshineDistillery.isCampfire(obj) or CCampfireSystem.instance:getLuaObjectOnSquare(sq) then
            isCampfire = true
            campfire = obj

            local fireopt = context:addOptionOnTop("Build Cooking Vat", worldobjects, function()
               local item = MoonshineDistillery.getMetalDrumItem(pl)
               if item then
                  if not getCore():getDebug() then inv:Remove(item) end

                  local toSpawn = IsoThumpable.new(getCell(), sq, "MoonshineDistillery_0", false, nil)
                  sq:AddTileObject(toSpawn)
                  toSpawn:setName("Cooking Vat")
                  toSpawn:setIsDismantable(false)
                  toSpawn:setIsThumpable(true)
                  toSpawn:setWaterAmount(0)
                  toSpawn:setIsContainer(true)
                  toSpawn:getContainer():setType("CookingVat")
                  getPlayerInventory(0):refreshBackpacks()
                  getPlayerLoot(0):refreshBackpacks()
                  toSpawn:getContainer():setDrawDirty(true)
                  toSpawn:transmitModData()
                  getSoundManager():PlayWorldSound("MoonshineBuild", getPlayer():getSquare(), 0, 5, 5, false)
               end
            end)

            if MoonshineDistillery.hasCookingVat(sq) or not MoonshineDistillery.getMetalDrumItem(pl) then
               fireopt.notAvailable = true
            end
         end

         if MoonshineDistillery.isCookingVat(sprName) then
            cookingVat = obj
            local cookingvatCont = cookingVat:getContainer()
            local stage = MoonshineDistillery.getStage(sprName)
            if cookingvatCont and stage then
               if  stage == "cooking" then
                  local cookM = context:addOptionOnTop("Cooking Vat: ")
                  cookM.iconTexture = getTexture("media/ui/Moonshine.png")
                  local cookopt = ISContextMenu:getNew(context)
                  context:addSubMenu(cookM, cookopt)

                  local timeleft = MoonshineDistillery.getRemainingCook(cookingVat)
                  cookopt:addOptionOnTop("Flavor: "..tostring(cookingVat:getModData()['Flavor']))
                  cookopt:addOptionOnTop("Time Remaining: "..tostring(timeleft))
                  cookopt:addOption("Cancel", worldobjects, function()
                     MoonshineDistillery.setStage(cookingVat, "empty")
                     cookingVat:getModData()['timestamp'] = nil
                     cookingVat:getModData()['Flavor'] = nil
                     cookingVat:transmitModData()
                     ISInventoryPage.dirtyUI();
                  end)
               end
               if  stage == "mash" then
                  if  MoonshineDistillery.getStage(sprName) == "mash" then
                     local vatopt = context:addOptionOnTop("Filter Moonshine", worldobjects, function()
                        local flavorMap = {
                           ["MoonDist.BucketMoonshineMashClear"] = "MoonDist.BucketMoonshineUnfermentedClear",
                           ["MoonDist.BucketMoonshineMashApple"] = "MoonDist.BucketMoonshineUnfermentedApple",
                           ["MoonDist.BucketMoonshineMashPeach"] = "MoonDist.BucketMoonshineUnfermentedPeach"
                        }
                        for itemType, newType in pairs(flavorMap) do
                           local item = cookingvatCont:FindAndReturn(itemType)
                           if item then
                              if isClient() then cookingvatCont:removeItemOnServer(item) end
                              cookingvatCont:DoRemoveItem(item)
                              cookingvatCont:AddItem(newType)
                              ISInventoryPage.dirtyUI()
                              break
                           end
                        end
                        MoonshineDistillery.setStage(obj, "empty")
                     end)
                     local ftip = ISWorldObjectContextMenu.addToolTip()
                     if not (pr and pr:getFullType() == "MoonDist.Strainer") then
                        ftip.description = "Need to use Strainer"
                        vatopt.notAvailable = true
                     end
                     if not checkDist then
                        ftip.description = "Need to use Strainer\n"..ftip.description
                        vatopt.notAvailable = true
                     end
                     vatopt.toolTip = ftip
                  end
               end
            end
         end
      end
   end

   if getCore():getDebug() and isAdmin() then
      if isCampfire then print("isCampfire") end
   end
end

Events.OnFillWorldObjectContextMenu.Remove(MoonshineDistillery.contextCV)
Events.OnFillWorldObjectContextMenu.Add(MoonshineDistillery.contextCV)

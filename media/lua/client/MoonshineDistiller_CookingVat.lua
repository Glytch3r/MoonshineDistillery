--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

MoonshineDistillery = MoonshineDistillery or {}
-----------------------            ---------------------------
function MoonshineDistillery.findCookingVats()
   local rad = 8
   local pl = getPlayer()
   if not pl then return {} end
   local cell = getCell()
   local x, y, z = pl:getX(), pl:getY(), pl:getZ()
   local vats = {}

   for xDelta = -rad, rad do
      for yDelta = -rad, rad do
         local sq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
         for i = 0, sq:getObjects():size() - 1 do
            local obj = sq:getObjects():get(i)
            if obj and obj:getSprite() then
               local sprName = obj:getSprite():getName()
               if sprName and MoonshineDistillery.isCookingVat(sprName) then
                  table.insert(vats, obj)
               end
            end
         end
      end
   end
   return vats
end

function MoonshineDistillery.findCookingVat()
   local rad = 8
   local pl = getPlayer()
   if not pl then return end
   local cell = getCell()
   local x, y, z = pl:getX(), pl:getY(), pl:getZ()
   for xDelta = -rad, rad do
      for yDelta = -rad, rad do
         local sq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
         for i = 0, sq:getObjects():size() - 1 do
            local obj = sq:getObjects():get(i)
            if obj and obj:getSprite() then
               local sprName = obj:getSprite():getName()
               if sprName and MoonshineDistillery.isCookingVat(sprName) then
                  return obj
               end
            end
         end
      end
   end
   return nil
end
-----------------------            ---------------------------
function MoonshineDistillery.getMashBase(cookingvatCont)
    if not cookingvatCont then return nil end
    local mashBuckets = {
        "MoonDist.MoonshineMashBaseClear",
        "MoonDist.MoonshineMashBaseApple",
        "MoonDist.MoonshineMashBasePeach"
    }
    for _, bucket in ipairs(mashBuckets) do
        local item = cookingvatCont:FindAndReturn(bucket)
        if item then return item end
    end
    return nil
end
function MoonshineDistillery.getMashBucket(cookingvatCont)
    if not cookingvatCont then return nil end
    local mashBuckets = {
        "MoonDist.BucketMoonshineMashClear",
        "MoonDist.BucketMoonshineMashApple",
        "MoonDist.BucketMoonshineMashPeach"
    }
    for _, bucket in ipairs(mashBuckets) do
        local item = cookingvatCont:FindAndReturn(bucket)
        if item then return item end
    end
    return nil
end

function MoonshineDistillery.getUnfermentedBucket(cookingvatCont)
    if not cookingvatCont then return nil end
    local unfermentedBuckets = {
        "MoonDist.BucketMoonshineUnfermentedClear",
        "MoonDist.BucketMoonshineUnfermentedApple",
        "MoonDist.BucketMoonshineUnfermentedPeach"
    }
    for _, bucket in ipairs(unfermentedBuckets) do
        local item = cookingvatCont:FindAndReturn(bucket)
        if item then return item end
    end
    return nil
end

-----------------------   cookingVat*        ---------------------------
function MoonshineDistillery.contextCV(player, context, worldobjects, test)
   local pl = getSpecificPlayer(player)
   local inv = pl:getInventory()
   local pr = pl:getPrimaryHandItem()
   local sq = clickedSquare
   if not MoonshineDistillery.isLearned(pl) then return end
   if not sq then return end
   local checkDist = MoonshineDistillery.checkDist(pl, sq)

   local isCampfire = false
   local campfire = nil

   for i = 0, sq:getObjects():size() - 1 do
      local obj = sq:getObjects():get(i)
      local spr = obj:getSprite()
      local sprName = spr and spr:getName()

      if sprName then
         if MoonshineDistillery.isCampfire(obj) or CCampfireSystem.instance:getLuaObjectOnSquare(sq) then
            isCampfire = true
            campfire = obj
            if not MoonshineDistillery.hasCookingVat(sq)  then
               local fireopt = context:addOptionOnTop("Build Cooking Vat", worldobjects, function()
                  local item = MoonshineDistillery.getMetalDrumItem(pl)
                  if item then
                     local itemFullType = item:getFullType()
                     if not getCore():getDebug() then inv:Remove(item) end

                     local toSpawn = IsoThumpable.new(getCell(), sq, "MoonshineDistillery_0", false, nil)
                     sq:AddTileObject(toSpawn)
                     toSpawn:setName("Cooking Vat")
                     toSpawn:setIsDismantable(false)
                     toSpawn:setIsThumpable(true)
                     --toSpawn:setWaterAmount(0)
                     toSpawn:setIsContainer(true)
                     toSpawn:getContainer():setType("CookingVat")
                     getPlayerInventory(0):refreshBackpacks()
                     getPlayerLoot(0):refreshBackpacks()
                     toSpawn:getContainer():setDrawDirty(true)

                     toSpawn:getModData()['itemFullType'] = itemFullType or "Base.MetalDrum"
                     toSpawn:transmitModData()
                     getSoundManager():PlayWorldSound("MoonshineBuild", getPlayer():getSquare(), 0, 5, 5, false)


                  end
               end)
               fireopt.iconTexture = getTexture("media/ui/CookingVat.png")

               if not MoonshineDistillery.getMetalDrumItem(pl) then
                  fireopt.notAvailable = true
               end
            end
         end

         if MoonshineDistillery.isCookingVat(sprName) then
            cookingVat = obj
            local cookingvatCont = cookingVat:getContainer()
            local stage = MoonshineDistillery.getStage(sprName)
            if cookingvatCont and stage then
               local cookM = context:addOptionOnTop("Cooking Vat: ")
               cookM.iconTexture = getTexture("media/ui/CookingVat.png")
               local cookopt = ISContextMenu:getNew(context)
               context:addSubMenu(cookM, cookopt)

               local cookMtip = ISWorldObjectContextMenu.addToolTip()

               local cap = "Stage: "..tostring(stage).."\n"
               if  stage == "empty" then
                  cap = cap.."Place Bucket of Water Inside Cooking Vat"
                  --cookM.notAvailable = true
                  local recopt = cookopt:addOptionOnTop("Reclaim Barrel", worldobjects, function()
                   --[[   local fType = cookingVat:getModData()['itemFullType'] or "Base.MetalDrum"
                     local item = InventoryItemFactory.CreateItem(fType);
                     sq:AddWorldInventoryItem(item, 0.5, 0.5, 0);
                     MoonshineDistillery.doSledge(cookingVat) ]]

                     MoonshineDistillery.doReclaim(cookingVat)

                     ISInventoryPage.dirtyUI();
                     context:hideAndChildren()
                  end)
                  if checkDist then
                      recopt.notAvailable = true
                  end
               end
               if  stage == "water" then
                  local hasMashBase = false
                  if MoonshineDistillery.getMashBase(cookingvatCont) ~= nil then
                     hasMashBase = true
                  end
                  if not hasMashBase then
                     cap = cap.."Place Moonshine Mash Base Inside Cooking Vat\n"
                  end
                  if not MoonshineDistillery.hasLitCampfire(sq) then
                     cap =  cap.."Light The Campfire\n"
                  end

               end

               if  stage == "cooking" then

                  local timeleft = MoonshineDistillery.getRemainingCookMins(cookingVat)
                  cap = cap.."Flavor: "..tostring(cookingVat:getModData()['Flavor'])
                  cap = cap.."\nTime Remaining: "..tostring(timeleft)

                  cookopt:addOption("Cancel", worldobjects, function()
                     MoonshineDistillery.setStage(cookingVat, "empty")
                     ISInventoryPage.dirtyUI();
                  end)
               end
               if  stage == "mash" then
                  cap = cap.."Leave the mash inside\nUse Strainer to filter"

                  local vatopt = cookopt:addOption("Filter Moonshine", worldobjects, function()
                     local flavorMap = {
                        ["MoonDist.BucketMoonshineMashClear"] = "MoonDist.BucketMoonshineUnfermentedClear",
                        ["MoonDist.BucketMoonshineMashApple"] = "MoonDist.BucketMoonshineUnfermentedApple",
                        ["MoonDist.BucketMoonshineMashPeach"] = "MoonDist.BucketMoonshineUnfermentedPeach"
                     }
                     for itemType, newType in pairs(flavorMap) do
                        local item = cookingvatCont:FindAndReturn(itemType)
                        if item then
                           if isClient() then cookingvatCont:removeItemOnServer(item) end
                           cookingvatCont:DoRemoveItem(item)
                           cookingvatCont:AddItem(newType)
                           ISInventoryPage.dirtyUI()
                           break
                        end
                     end
                     MoonshineDistillery.setStage(obj, "unfermented")
                  end)
                  local ftip = ISWorldObjectContextMenu.addToolTip()
                  ftip.description = ""
                  if not (pr and pr:getFullType() == "MoonDist.Strainer") then
                     ftip.description = "Need to use Strainer"
                     vatopt.notAvailable = true
                  end
                  if not checkDist then
                     if ftip.description ~= "" then
                        ftip.description = ftip.description.."\n"
                     end
                     ftip.description = ftip.description.."Too Far Away"
                     vatopt.notAvailable = true
                  end
                  vatopt.toolTip = ftip
               end

               if  stage == "unfermented" then
                  cap = cap.."Take the Unfermented Moonshine to the distiller"
               end

               cookMtip.description = cap
               cookM.toolTip = cookMtip
            end
         end
      end
   end

end

Events.OnFillWorldObjectContextMenu.Remove(MoonshineDistillery.contextCV)
Events.OnFillWorldObjectContextMenu.Add(MoonshineDistillery.contextCV)

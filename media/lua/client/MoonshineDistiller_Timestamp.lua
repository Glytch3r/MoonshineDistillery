--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													                   |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							                |
|                       		                                    														 	                   |
|                       	Discord:    Glytch3r#1337 / glytch3r															                      |
|                       		                                    													                  	 	 |
|                       	Support:    https://ko-fi.com/glytch3r														                      	 |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

MoonshineDistillery = MoonshineDistillery or {}


function MoonshineDistillery.isCampfire(obj)
   if obj:getName() == "Campfire" then return true end
   local spr = obj:getSprite()
   local sprName = spr and spr:getName()
   if not sprName then return false  end
   local tab = {
      ["camping_01_6"]=true,
      ["camping_01_5"]=true,
      ["camping_01_4"]=true,
   }
   return tab[sprName] or false
end



function MoonshineDistillery.getCampfire(sq)
   for i = 0, sq:getObjects():size() - 1 do
      local obj = sq:getObjects():get(i)
      if MoonshineDistillery.isCampfire(obj) then
         return obj
      end
   end
   return nil
end

function MoonshineDistillery.hasCampfire(sq)
   return MoonshineDistillery.getCampfire(sq) ~= nil
end
function MoonshineDistillery.hasLitCampfire(sq)
   local campfire = MoonshineDistillery.getCampfire(sq)

   local isLit = campfire and campfire:getModData().isLit
   local fuelAmt = campfire and campfire:getModData().fuelAmt

   return isLit and fuelAmt > 0
end
-----------------------

function MoonshineDistillery.isCookingVat(sprName)
   local tab = {
      ["MoonshineDistillery_0"]=true,
      ["MoonshineDistillery_1"]=true,
      ["MoonshineDistillery_2"]=true,
      ["MoonshineDistillery_3"]=true,
      ["MoonshineDistillery_4"]=true,
   }
   return tab[sprName]
end

function MoonshineDistillery.hasCookingVat(sq)
   for i = 0, sq:getObjects():size() - 1 do
      local obj = sq:getObjects():get(i)
      if obj and obj:getSprite() then
         local sprName = obj:getSprite():getName()
         if sprName and MoonshineDistillery.isCookingVat(sprName) then
            return true
         end
      end
   end
   return false
end

function MoonshineDistillery.getCookingVat(sq)
   for i = 0, sq:getObjects():size() - 1 do
      local obj = sq:getObjects():get(i)
      if obj and obj:getSprite() then
         local sprName = obj:getSprite():getName()
         if sprName and MoonshineDistillery.isCookingVat(sprName) then
            return obj
         end
      end
   end
   return nil
end

function MoonshineDistillery.findCookingVat()
   local count = 0
   local rad = 8
   local pl = getPlayer()
   local sq = pl:getCurrentSquare()
   local cell = getCell()
   local x, y, z = sq:getX(), sq:getY(), sq:getZ()
   for xDelta = -rad, rad do
      for yDelta = -rad, rad do
         local sq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
         for i = 0, sq:getObjects():size() - 1 do
            local obj = sq:getObjects():get(i)
            if obj and obj:getSprite() then
               local sprName = obj:getSprite():getName()
               if sprName and MoonshineDistillery.isCookingVat(sprName) then
                  return obj
               end
            end
         end
      end
   end
   return nil
end



function MoonshineDistillery.getStage(sprName)
    local tab = {
        ["MoonshineDistillery_0"] = "empty",
        ["MoonshineDistillery_1"] = "water",
        ["MoonshineDistillery_2"] = "mash",
        ["MoonshineDistillery_3"] = "unfermented",
        ["MoonshineDistillery_4"] = "cooking",
    }
    return tab[sprName]
end


function MoonshineDistillery.getCookingVatTimer()
   return SandboxVars.MoonshineDistillery.HeatingMinutes or 24
end
--[[
function MoonshineDistillery.isCampfireLitWithFuel(campfire)
    if not campfire or not instanceof(campfire, "IsoFireplace") then return false end
    local hrs = MoonshineDistillery.getCookingVatTimer()
    return campfire:isLit() and campfire:getFuelAmount() >= (hrs * 60)
end

 ]]


function MoonshineDistillery.setStage(obj, stage)
    local tab = {
      ["empty"] =  "MoonshineDistillery_0",
      ["water"] =  "MoonshineDistillery_1",
      ["mash"] =  "MoonshineDistillery_2",
      ["unfermented"] = "MoonshineDistillery_3",
      ["cooking"] =  "MoonshineDistillery_4",
    }
   local nextStage =  tab[stage]
   MoonshineDistillery.setSprite(obj, nextStage)
end
function MoonshineDistillery.getRemainingHours(obj)
   if MoonshineDistillery.getStage(obj:getSprite():getName()) == "cooking" then
      local targetTimestamp = obj:getModData()['MoonshineCookTimeStamp']
      local currentTime = getGameTime():getWorldAgeHours()
      if currentTime >= targetTimestamp then
         MoonshineDistillery.setStage(obj, "mash")
      else
         return math.max(0, targetTimestamp - currentTime)
      end
   end
end
function MoonshineDistillery.getTimeStamp()
   return getGameTime():getWorldAgeHours()
end

function MoonshineDistillery.setTimeStamp(obj)
   obj:getModData()['MoonshineCookTimeStamp'] = getGameTime():getWorldAgeHours() +  tonumber(MoonshineDistillery.getCookingVatTimer())
end

function MoonshineDistillery.getMashBase(inv)
   local tab = {
      ["Clear"] = inv:FindAndReturn("MoonDist.MoonshineMashBaseClear") or nil,
      ["Apple"] = inv:FindAndReturn("MoonDist.MoonshineMashBaseApple") or nil,
      ["Peach"] = inv:FindAndReturn("MoonDist.MoonshineMashBasePeach") or nil,
   }

   return tab
end
function MoonshineDistillery.timetester(pl)
   local targtime = (SandboxVars.MoonshineDistillery.HeatingMinutes or 1440) / 60
   local cookingVat = MoonshineDistillery.findCookingVat()
   if not cookingVat then return end
   local cont = cookingVat:getContainer()
   local sq = cookingVat:getSquare()
   local sprName = cookingVat:getSprite():getName()
   local stage = MoonshineDistillery.getStage(sprName)

   local campfire = MoonshineDistillery.getCampfire(sq)
   local isLit = campfire and campfire:getModData().isLit
   local fuelAmt = campfire and campfire:getModData().fuelAmt

   local cookData = cookingVat:getModData()
   local timecheck = getGameTime():getWorldAgeHours() - (cookData['timestamp'] or 0)
   if stage == "empty" then
      if cont and MoonshineDistillery.hasMashBasePlaced(cont) then
         MoonshineDistillery.setStage(cookingVat, "water")
      end
   elseif stage == "water"  then
      MoonshineDistillery.setStage(cookingVat, "cooking")
      cookData["Flavor"] = nil
      if  cont:FindAndReturn("MoonDist.MoonshineMashBaseClear") then
         cookData["Flavor"] = "Clear"
      elseif cont:FindAndReturn("MoonDist.MoonshineMashBaseApple")  then
         cookData["Flavor"] = "Clear"
      elseif cont:FindAndReturn("MoonDist.MoonshineMashBasePeach")  then
         cookData["Flavor"] = "Clear"
      end

      if not cookData['timestamp'] then
         cookData['timestamp'] = getGameTime():getWorldAgeHours()
      end
      if isLit then
         MoonshineDistillery.setStage(cookingVat, "cooking")
      end
      cookingVat:transmitModData()
   elseif stage == "cooking" then
      if timecheck >= targtime and isLit then
         MoonshineDistillery.setStage(cookingVat, "mash")

         cookData['timestamp'] = nil

         cookingVat:transmitModData()
      elseif not isLit then
         MoonshineDistillery.setStage(cookingVat, "water")
         cookData['timestamp'] = nil
         cookingVat:transmitModData()
      end
   elseif stage == "unfermented" then
      if not (cont:FindAndReturn("MoonDist.BucketMoonshineUnfermentedClear") and cont:FindAndReturn("MoonDist.BucketMoonshineUnfermentedApple")
      and cont:FindAndReturn("MoonDist.BucketMoonshineUnfermentedPeach")) then
         MoonshineDistillery.setStage(cookingVat, "empty")
         cookData['timestamp'] = nil
         cookData['Flavor'] = nil
         cookData['MashCount'] = nil

      end
   end
end



Events.EveryOneMinute.Add(MoonshineDistillery.timetester)


--[[
function MoonshineDistillery.timetester(pl)

   local timestamp = nil
   local targtime = SandboxVars.MoonshineDistillery.HeatingMinutes or 1440


   local cookingVat = MoonshineDistillery.findCookingVat()
   local campfire = nil
   local sq = nil
   local sprName = nil
   if not cookingVat then return end
   if cookingVat then
      sq = cookingVat:getSquare()
      sprName = cookingVat:getSprite():getName()
   end
   if sq then
      if MoonshineDistillery.hasCampfire(sq) then
         campfire = MoonshineDistillery.getCampfire(sq)
      end
   end

   local isEmpty = MoonshineDistillery.getStage(sprName) == "empty"
   local isWater = MoonshineDistillery.getStage(sprName) == "water"
   local isMash = MoonshineDistillery.getStage(sprName) == "mash"
   local isUnfermented = MoonshineDistillery.getStage(sprName) == "unfermented"
   local isCooking = MoonshineDistillery.getStage(sprName) == "cooking"

   if campfire then
      local md = campfire:getModData()
      local fuelAmt  = nil
      local isLit = nil
      if md then
         fuelAmt = ['fuelAmt']
         isLit = ['isLit']
      end
   elseif not (campfire or isLit) then
      if isCooking then

      end
   end

   local cookData = cookingVat:getModData()
   if isWater then
      if isLit then

         MoonshineDistillery.setStage(cookingVat, "cooking")
         if cookData then
            if cookData['timestamp'] == nil then
               cookData['timestamp'] = getGameTime():getWorldAgeHours()
               cookingVat:transmitModData()
            end
         end
      end
   elseif isCooking then
      MoonshineDistillery.setStage(cookingVat, "mash")

      timecheck = getGameTime():getWorldAgeHours() - cookData['timestamp']
      if timecheck >= targtime and isLit then
         cookData['timestamp'] = nil
         cookingVat:transmitModData()
      elseif not (timecheck >= targtime or isLit ) then
         MoonshineDistillery.setStage(cookingVat, "mash")
      end
   end
end

Events.EveryOneMinute.Add(MoonshineDistillery.timetester)
 ]]
--notes:

--[[
   the idea is that the cooking vat is on top of the campfire and piggbacks off its flame
   stages:
      empty -- initial stage
      water -- once player manually adds water   -- context menu will auto change sprite to water
      cooking -- after player places the mash base and lits up the campfire then will auto change to this stage
      mash --  cookin requires the campfire to stay lit all time so if the game detects the campfire is unlit or is removed from the square where the cooking vat is also placed then it should reset back to empty (failed)
      unfermented -- final stage and its the end product if cooking is successful --once player removes the item on the container then it resets to empty



]]
--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

MoonshineDistillery = MoonshineDistillery or {}

function MoonshineDistillery.loadCursor()
    ISMoonshineTileCursor = ISBuildingObject:derive("ISMoonshineTileCursor")

    function ISMoonshineTileCursor:setDragNilAfterPlace(nilAfter)
        self.dragNilAfterPlace = nilAfter
    end
    function ISMoonshineTileCursor:create(x, y, z, firstSq)
        local pl = getPlayer()
        local spr = self.spr
        firstSq = firstSq or self.firstSq
        local err = false

        local positions = {}
        if spr == "MoonshineDistillery_16" then
            positions = {
                {x, y, z, "MoonshineDistillery_16"}, --boiler
                {x + 1, y, z, "MoonshineDistillery_17"}, -- thumper tall
                {x + 1, y - 1, z, "MoonshineDistillery_18"}, -- thumper short
                {x + 1, y - 1, z, "MoonshineDistillery_19"}, -- can
                --{x + 1, y - 1, z, "MoonshineDistillery_22"}, -- DrainPort
                --{x, y, z, "MoonshineDistillery_21"}, --Thermometer
                --{x, y, z, "MoonshineDistillery_20"}, --StillCap
            }
        elseif spr == "MoonshineDistillery_27" then
            positions = {
                {x, y, z, "MoonshineDistillery_27"}, --boiler
                {x, y + 1, z, "MoonshineDistillery_26"}, -- thumper tall
                {x - 1, y + 1, z, "MoonshineDistillery_25"}, -- thumper short
                {x - 1, y + 1, z, "MoonshineDistillery_24"}, -- can
                --{x - 1, y + 1, z, "MoonshineDistillery_30"} -- DrainPort
                --{x, y, z, "MoonshineDistillery_29"}, --Thermometer
                --{x, y, z, "MoonshineDistillery_28"}, --StillCap
            }
        end
        self.positions = positions
        local firstSq = getCell():getOrCreateGridSquare(x, y, z)
        if not MoonshineDistillery.checkDist(pl, firstSq) then
            pl:setHaloNote("Need to get closer", 150, 250, 150, 900)
            err = true
        end

        for _, pos in ipairs(positions) do
            local square = getCell():getGridSquare(pos[1], pos[2], pos[3])
            if not (square or square:isFree(false)) and MoonshineDistillery.isNothingThere(square) then
                pl:setHaloNote("Cannot place there", 150, 250, 150, 900)
                err = true
            end
            local flr = square:getFloor()
            if flr then
                flr:setHighlighted(true, true);
            end
        end
        if err then
            getCell():setDrag(nil, 0)
            ISMoveableCursor.clearCacheForAllPlayers();
            return
        end
        for _, pos in ipairs(positions) do
            local square = getCell():getGridSquare(pos[1], pos[2], pos[3])
            if square then
                local props = ISMoveableSpriteProps.new(IsoObject.new(square, pos[4]):getSprite())
                props.rawWeight = 10
                props:placeMoveableInternal(square, InventoryItemFactory.CreateItem("Base.Plank"), pos[4])
                getCell():setDrag(nil, 0)
            end
        end
        addSound(pl, firstSq:getX(), firstSq:getY(), firstSq:getZ(), 5, 1)
        getSoundManager():PlayWorldSound('MoonshineBuild', firstSq, 0, 5, 5, false)

        if not err then
            if not MoonshineDistillery.delBuildItems(pl) then
                pl:setHaloNote(tostring("Failed to build Moonshine Distiller"), 250,250,250,900)
                ISMoveableCursor.clearCacheForAllPlayers();
                getCell():setDrag(nil, 0)

                return
            end
        end

    end
    function ISMoonshineTileCursor:rotateKey(key)
        --getCell():setDrag(nil, 0)
        self.main = "MoonshineDistillery_16"
        self.alt = "MoonshineDistillery_27"
        if self.spr == self.main then
            self.spr = self.alt
            self:setSprite(self.alt)
            self:setNorthSprite(self.main)
            self.spriteName = self.alt
        else
            self.spr = self.main
            self:setSprite(self.main)
            self:setNorthSprite(self.alt)
            self.spriteName = self.main
        end
        if getCore():getDebug() then
            print(self:getSprite())
        end
    end
--[[
    function ISMoonshineTileCursor:rotateKey(key)
        if key == getCore():getKey("Rotate building") then
            if self.spr	 == "MoonshineDistillery_16" then
                self.spr = "MoonshineDistillery_27"
            else
                self.spr = "MoonshineDistillery_16"
            end

            local cursor = ISMoonshineTileCursor:new(self.spr,  getPlayer() , square)
            getCell():setDrag(cursor, 0)
            ISMoveableCursor.clearCacheForAllPlayers();
            return
        end
    end ]]

    function ISMoonshineTileCursor:render(x, y, z, square)


        ISBuildingObject.render(self, x, y, z, square)
    end

    function ISMoonshineTileCursor:new(spr, character, firstSq)
        local o = setmetatable({}, self)
        self.__index = self
        o:init()
        o:setSprite(spr)
        o.spr = spr
        o.spr2 = "MoonshineDistillery_27"
        if spr == "MoonshineDistillery_27" then
          o.spr2 = "MoonshineDistillery_16"
        end
        o:setNorthSprite(o.spr2)
        o.firstSq = firstSq
        o.square = firstSq
        o.character = character
        o.player = character:getPlayerNum()
        o.isTileCursor = true
        o.spriteName = spr
        o.noNeedHammer = true
        o.skipBuildAction = false
        o.skipWalk2 = false
        o.canBeAlwaysPlaced = true
        o.cd = false
        o.ticks = 0
        return o
    end
end

function MoonshineDistillery.isNothingThere(square)
    local pl = getPlayer()
	if not square then return false end

    --if square:isSomethingTo(pl:getSquare()) then return false end
	--if pl:getCurrentSquare():isBlockedTo(square) then return false end
	if square:isSolid() or square:isSolidTrans() then return false end
	if square:HasStairs() then return false end
	if square:HasTree() then return false end
	--if not square:getMovingObjects():isEmpty() then return false end
	if not square:TreatAsSolidFloor() then return false end
	--if not self:haveMaterial(square) then return false end
--[[ 	for i=1,square:getObjects():size() do
		local obj = square:getObjects():get(i-1)
		if obj:getSprite() == obj:getTextureName() then return false end
    end ]]
    if buildUtil.stairIsBlockingPlacement( square, true ) then return false; end
	if square:isVehicleIntersecting() then return false end
	return true
end
-------
Events.OnCreatePlayer.Add(function()
    MoonshineDistillery.loadCursor()
end)

--[[

   MoonshineDistillery.loadCursor()

]]






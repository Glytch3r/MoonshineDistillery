--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													                   |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							                |
|                       		                                    														 	                   |
|                       	Discord:    Glytch3r#1337 / glytch3r															                      |
|                       		                                    													                  	 	 |
|                       	Support:    https://ko-fi.com/glytch3r														                      	 |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

MoonshineDistillery = MoonshineDistillery or {}

MoonshineDistillery.flavors = {"Clear","Apple","Peach"}

function MoonshineDistillery.getDistillerTimer()
   return SandboxVars.MoonshineDistillery.FermentationMinutes or 120
end



function MoonshineDistillery.setSprite(obj, sprName)
   obj:setSprite(sprName)
   obj:getSprite():setName(sprName)
   local cont = obj:getContainer()
   if cont then
      cont:setDrawDirty(true)
   end
   ISInventoryPage.renderDirty = true
   if isClient() then
      obj:transmitCompleteItemToServer()
      obj:transmitUpdatedSpriteToClients()
   end
   getPlayerInventory(0):refreshBackpacks()
   getPlayerLoot(0):refreshBackpacks()

end



function MoonshineDistillery.delItem(cont, fType, qty)
    qty = qty or 1
    local count = cont:getItemCount(fType)
    --local count = item:getContainer():getNumberOfItem(fType)
    if count >= qty then
        for i=1, qty do
            local item = cont:FindAndReturn(fType)
            if item then
                if isClient() then
                    cont:removeItemOnServer(item)
                end
                cont:DoRemoveItem(item)
            end
        end
        getPlayerLoot(0):refreshBackpacks()
    end
end

function MoonshineDistillery.context(player, context, worldobjects, test)
   local pl = getSpecificPlayer(player)
   local inv = pl:getInventory()
   local sq = clickedSquare
   if not MoonshineDistillery.isLearned(pl) then return end
   if not sq then return end
   local checkDist = MoonshineDistillery.checkDist(pl, sq)
   if MoonshineDistillery.CanPlace(pl) then
      local Main = context:addOptionOnTop("Build Moonshine Distiller: ")
      Main.iconTexture = getTexture("media/ui/Moonshine.png")
      local opt = ISContextMenu:getNew(context)
      context:addSubMenu(Main, opt)



      local sOpt = opt:addOption('South', worldobjects, function()
         local cursor = ISMoonshineTileCursor:new("MoonshineDistillery_16",  pl, sq)
         getCell():setDrag(cursor, 0)
         ISMoveableCursor.clearCacheForAllPlayers();
      end)

      local tip = ISWorldObjectContextMenu.addToolTip()
      tip.description = "Moonshine Distiller South"
      local iconPath = "media/ui/MoonshineDistillerEast.png"
      sOpt.iconTexture = getTexture(iconPath)
      --tip:setTexture(iconPath)
      sOpt.toolTip = tip

      local eOpt = opt:addOption('East', worldobjects, function()
         local cursor = ISMoonshineTileCursor:new("MoonshineDistillery_27",  pl, sq)
         getCell():setDrag(cursor, 0)
         ISMoveableCursor.clearCacheForAllPlayers();
      end)

      local tip = ISWorldObjectContextMenu.addToolTip()
      tip.description = "Moonshine Distiller East"
      local iconPath = "media/ui/MoonshineDistillerEast.png"
      eOpt.iconTexture = getTexture(iconPath)
      --tip:setTexture(iconPath)
      eOpt.toolTip = tip

   end
   local isBoilerTile, boiler
   local isCampfire, campfire
   local isCookingVat, cookingvat
   for i=0, sq:getObjects():size()-1 do
      local obj = sq:getObjects():get(i)
      local spr = obj:getSprite()
      local sprName
      if spr then
         sprName = spr:getName()
         if sprName then
            -----------------------    boiler*        ---------------------------
            if MoonshineDistillery.isBoilerTile(sprName) then
               isBoilerTile = true
               boiler = obj
               local obj = boiler
               local installMenu = context:addOptionOnTop("Install Parts")
               installMenu.iconTexture = getTexture("media/ui/MoonshineInstall.png")
               local opt = ISContextMenu:getNew(context)
               context:addSubMenu(installMenu, opt)

               if checkDist then
                  local sprName = obj:getSprite():getName()

                  local optTip = opt:addOptionOnTop('Thermometer', worldobjects, function()
                     local part = "Thermometer"
                     local item = MoonshineDistillery.getThermometer(pl)
                     if item then
                        local sprToSpawn = MoonshineDistillery.getOverlayToAdd(sprName, part)
                        MoonshineDistillery.spawnPart(sprToSpawn, sq, item, inv)
                     end
                  end)

                  if MoonshineDistillery.hasThermometerItem(pl) then
                     optTip.notAvailable = true
                  end





                  local optTip = opt:addOptionOnTop('Still Cap', worldobjects, function()
                     local part = "StillCap"
                     local sprToSpawn = MoonshineDistillery.getOverlayToAdd(sprName, part)
                     local item = MoonshineDistillery.getStillCap(pl)
                     if item then
                        --MoonshineDistillery.addOverlay(obj, sprName, part, item)
                        MoonshineDistillery.spawnPart(sprToSpawn, sq, item, inv)
                        obj:setIsThumpable(true)
                        obj:setIsContainer(true)
                        obj:setIsDismantable(false)
                        obj:getContainer():setType('Distiller')

                        obj:getContainer():setDrawDirty(true);
                        if isClient() then
                           obj:transmitCompleteItemToServer()
                           obj:transmitUpdatedSpriteToClients()
                        end
                        getPlayerInventory(0):refreshBackpacks()
                        getPlayerLoot(0):refreshBackpacks()
                     end
                  end)
                  if MoonshineDistillery.hasStillCapItem(pl) then
                     optTip.notAvailable = true
                  end


                  local x, y, z = round(obj:getX()),  round(obj:getY()),  obj:getZ()
                  local sq2 =  MoonshineDistillery.getDrainPortSquare(x, y, z, sprName)
                  if sq2  then
                     local flr = sq2:getFloor()
                     if sq2 and flr then
                        flr:setHighlighted(true, true)
                     end
                     local optTip = opt:addOptionOnTop('Drain Port', worldobjects, function()
                        local item = MoonshineDistillery.getDrainPort(pl)
                        if item then
                           MoonshineDistillery.setDrainPort(sq2, sprName)
                           MoonshineDistillery.delInvItem(item, inv)
                        end
                     end)
                     if MoonshineDistillery.hasDrainPortItem(pl) then
                        optTip.notAvailable = true
                     end
                  end
               end
            end

            -----------------------   cookingVat*        ---------------------------

            if MoonshineDistillery.isCookingVat(sprName) then


               local cookingvatCont
               local cookvatmenu = context:addOptionOnTop("Cooking Vat:")
               cookvatmenu.iconTexture = getTexture("media/ui/MoonshineMashBase.png")
               local copt = ISContextMenu:getNew(context)
               context:addSubMenu(cookvatmenu, copt)

               if cookingvat then
                  cookingvatCont = obj:getContainer()
               end
               if cookingvatCont ~= nil then
                  --if MoonshineDistillery.checkDist(pl, sq) then
                     local stage = MoonshineDistillery.getStage(sprName)

                     if (getCore():getDebug() and isAdmin()) then
                        context:addOptionOnTop("Cooking Vat Stage: "..tostring(stage))
                     end

                     local optTipWater = copt:addOptionOnTop('Add Water', worldobjects, function()
                        MoonshineDistillery.setStage(obj, "water")
                     end)

                     if stage ~= "empty" then optTipWater.notAvailable = true end

                     local waterMenu = copt:addOptionOnTop("Add Mash Base")
                     waterMenu.iconTexture = getTexture("media/ui/MoonshineMashBase.png")
                     local optMash = ISContextMenu:getNew(context)
                     copt:addSubMenu(waterMenu, optMash)


                     if cont and MoonshineDistillery.hasMashBasePlaced(cont) then
                        local addClear = optMash:addOptionOnTop('Clear Base', worldobjects, function()
                           MoonshineDistillery.delInvItem(clearbase, inv)
                           MoonshineDistillery.setStage(obj, "mash")
                           obj:getModData()['MashCount'] = 4
                           obj:getModData()['Flavor'] = "Clear"
                           getSoundManager():playUISound("UIActivateMainMenuItem")
                        end)

                        local addApple = optMash:addOptionOnTop('Apple Base', worldobjects, function()
                           MoonshineDistillery.delInvItem(applebase, inv)
                           MoonshineDistillery.setStage(obj, "mash")
                           obj:getModData()['MashCount'] = 4
                           obj:getModData()['Flavor'] = "Apple"
                           getSoundManager():playUISound("UIActivateMainMenuItem")
                        end)

                        local addPeach = optMash:addOptionOnTop('Peach Base', worldobjects, function()
                           MoonshineDistillery.delInvItem(peachbase, inv)
                           MoonshineDistillery.setStage(obj, "mash")
                           obj:getModData()['MashCount'] = 4
                           obj:getModData()['Flavor'] = "Peach"
                           getSoundManager():playUISound("UIActivateMainMenuItem")
                        end)

                        if stage ~= "water" then
                           addClear.notAvailable = true
                           addApple.notAvailable = true
                           addPeach.notAvailable = true
                        else
                           if not cont:FindAndReturn("MoonDist.MoonshineMashBaseClear") then addClear.notAvailable = true end
                           if not cont:FindAndReturn("MoonDist.MoonshineMashBaseApple") then addApple.notAvailable = true end
                           if not cont:FindAndReturn("MoonDist.MoonshineMashBasePeach") then addPeach.notAvailable = true end
                        end

                     end
                     local emptyBucket = inv:FindAndReturn("Base.BucketEmpty")
                     if stage == "mash" then
                        local optTipFilter = copt:addOptionOnTop('Filter using Strainer', worldobjects, function()
                           local md = obj:getModData()
                           if md then
                              if md.MashCount and md.MashCount > 0 then
                                 local cont = cookingvatCont

                                 if not emptyBucket then return end

                                 MoonshineDistillery.delInvItem("emptyBucket", inv)
                                 local flav = md.Flavor or "Clear"
                                 local itemType = "BucketMoonshineMash" .. tostring(flav)

                                 if cont and MoonshineDistillery.delContItem("BucketEmpty", cont) then

                                    md.MashCount = md.MashCount - 1
                                    obj:transmitModData()
                                 end
                              end
                              if md.MashCount <= 0 then
                                 cont:AddItems("MoonDist.BucketMoonshineUnfermented"..tostring(flav), 4)
                                 MoonshineDistillery.setStage(obj, "unfermented")
                              end
                           end
                        end)
                        if (not pl:getPrimaryHandItem() or pl:getPrimaryHandItem():getFullType() ~= "MoonDist.Strainer") or not emptyBucket then
                           local tip = ISWorldObjectContextMenu.addToolTip()
                           tip.description = "Requires Strainer and Empty Buckets"
                           optTipFilter.toolTip = tip
                           optTipFilter.notAvailable = true
                        end
                     end

                     if stage == "cooking" then
                        local eta = MoonshineDistillery.getRemainingHours(obj)
                        local optTipCook = copt:addOptionOnTop('Process Moonshine', worldobjects, function()
                           getSoundManager():playUISound("UIActivateMainMenuItem")
                        end)
                        local tip = ISWorldObjectContextMenu.addToolTip()
                        tip.description = "Remaining time: " .. (eta and math.floor(eta) or "Unknown") .. " hours"
                        optTip.toolTip = tip
                     end
                  --end
               end
            end
               -----------------------    campfire*        ---------------------------
            if MoonshineDistillery.isCampfire(obj) or CCampfireSystem.instance:getLuaObjectOnSquare(sq) then
               isCampfire = true
               campfire = obj


               local obj = campfire
               local fireopt = context:addOptionOnTop('Build Cooking Vat', worldobjects, function()
                  local item = MoonshineDistillery.getMetalDrumItem(pl)
                  if item then
                     if getCore():getDebug() then
                        print("Debug mode bypassed MetalDrum Removal")
                     else
                        inv:Remove(item)
                     end
                     local toSpawn = IsoThumpable.new(getCell(), sq, "MoonshineDistillery_0", false, nil);
                     sq:AddTileObject(toSpawn);
                     toSpawn:setName("Cooking Vat")
                     toSpawn:setIsDismantable(false)
                     toSpawn:setIsThumpable(true)
                     toSpawn:setWaterAmount(0)
                     toSpawn:setIsContainer(true);
                     toSpawn:getContainer():setType('CookingVat')
                     getPlayerInventory(0):refreshBackpacks()
                     getPlayerLoot(0):refreshBackpacks()
                     toSpawn:getContainer():setDrawDirty(true);
                     toSpawn:transmitModData()
                  end
               end)
               if MoonshineDistillery.hasCookingVat(sq) or not MoonshineDistillery.getMetalDrumItem(pl) then
                  fireopt.notAvailable = true
               end
            end
            -----------------------            ---------------------------
         end --sprName
      end --spr
      -----------------------            ---------------------------
   end


   -----------------------            ---------------------------



   if (getCore():getDebug() and isAdmin()) then
      if isCampfire  then print("isCampfire ") end
      if isCookingVat  then print("isCookingVat ") end
      if isBoilerTile  then print("isBoilerTile ") end
   end

   -----------------------            ---------------------------
end


Events.OnFillWorldObjectContextMenu.Remove(MoonshineDistillery.context)
Events.OnFillWorldObjectContextMenu.Add(MoonshineDistillery.context)

function MoonshineDistillery.hasMashBasePlaced(cont)
   return cont:FindAndReturn("MoonDist.MoonshineMashBaseClear") or cont:FindAndReturn("MoonDist.MoonshineMashBaseApple") or cont:FindAndReturn("MoonDist.MoonshineMashBasePeach")
end
-----------------------            ---------------------------
--[[
obj:getModData()[''] =
if isClient() then
   obj:transmitCompleteItemToServer()
   obj:transmitUpdatedSpriteToClients()
end
obj:transmitModData()
]]
-----------------------            ---------------------------

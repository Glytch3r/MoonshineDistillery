--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													                   |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							                |
|                       		                                    														 	                   |
|                       	Discord:    Glytch3r#1337 / glytch3r															                      |
|                       		                                    													                  	 	 |
|                       	Support:    https://ko-fi.com/glytch3r														                      	 |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

MoonshineDistillery = MoonshineDistillery or {}

MoonshineDistillery.flavors = {"Clear","Apple","Peach"}

function MoonshineDistillery.getDistillerTimer()
   return SandboxVars.MoonshineDistillery.FermentationMinutes or 120
end



function MoonshineDistillery.setSprite(obj, sprName)
   obj:setSprite(sprName)
   obj:getSprite():setName(sprName)
   local cont = obj:getContainer()
   if cont then
      cont:setDrawDirty(true)
   end
   ISInventoryPage.renderDirty = true
   if isClient() then
      obj:transmitCompleteItemToServer()
      obj:transmitUpdatedSpriteToClients()
   end
   getPlayerInventory(0):refreshBackpacks()
   getPlayerLoot(0):refreshBackpacks()

end



function MoonshineDistillery.delItem(cont, fType, qty)
    qty = qty or 1
    local count = cont:getItemCount(fType)
    --local count = item:getContainer():getNumberOfItem(fType)
    if count >= qty then
        for i=1, qty do
            local item = cont:FindAndReturn(fType)
            if item then
                if isClient() then
                    cont:removeItemOnServer(item)
                end
                cont:DoRemoveItem(item)
            end
        end
        getPlayerLoot(0):refreshBackpacks()
    end
end
function MoonshineDistillery.DistillerContext(player, context, worldobjects, test)
   local pl = getSpecificPlayer(player)
   local inv = pl:getInventory()
   local sq = clickedSquare
   if not MoonshineDistillery.isLearned(pl) then return end
   if not sq then return end
   local checkDist = MoonshineDistillery.checkDist(pl, sq)
   -----------------------            ---------------------------
   local mMenu = context:addOptionOnTop("Moonshine Distiller:")
   mMenu.iconTexture = getTexture("media/ui/MoonshineInstall.png")
   local main = ISContextMenu:getNew(context)
   context:addSubMenu(mMenu, main)
   -----------------------            ---------------------------

   local buildm = main:addOptionOnTop("Build Distiller: ")
   buildm.iconTexture = getTexture("media/ui/Moonshine.png")
   local bopt = ISContextMenu:getNew(main)
   main:addSubMenu(buildm, bopt)

   local sOpt = bopt:addOption('South', worldobjects, function()
      local cursor = ISMoonshineTileCursor:new("MoonshineDistillery_16",  pl, sq)
      getCell():setDrag(cursor, 0)
      ISMoveableCursor.clearCacheForAllPlayers();
   end)

   local stip = ISWorldObjectContextMenu.addToolTip()
   stip.description = "South"
   sOpt.iconTexture = getTexture("media/ui/MoonshineDistillerSouth.png")
   --tip:setTexture(iconPath)
   sOpt.toolTip = stip

   local eOpt = bopt:addOption('East', worldobjects, function()
      local cursor = ISMoonshineTileCursor:new("MoonshineDistillery_27",  pl, sq)
      getCell():setDrag(cursor, 0)
      ISMoveableCursor.clearCacheForAllPlayers();
   end)

   local etip = ISWorldObjectContextMenu.addToolTip()
   etip.description = "East"
   eOpt.iconTexture = getTexture("media/ui/MoonshineDistillerEast.png")
   --tip:setTexture(iconPath)
   eOpt.toolTip = etip

   if not MoonshineDistillery.CanPlace(pl) then
      local ptip = ISWorldObjectContextMenu.addToolTip()
      buildm.notAvailable = true
      sOpt.notAvailable = true
      eOpt.notAvailable = true
      ptip.description = "Requires Boiler and Thumper"
      buildm.toolTip = ptip
   end

   local installMenu = main:addOptionOnTop("Install Parts")
   installMenu.iconTexture = getTexture("media/ui/MoonshineInstall.png")
   local isntopt = ISContextMenu:getNew(main)
   main:addSubMenu(installMenu, isntopt)
   local isBoilerTile
   if checkDist then
      for i=0, sq:getObjects():size()-1 do
         local obj = sq:getObjects():get(i)
         local spr = obj:getSprite()
         local sprName
         if spr then
            sprName = spr:getName()

            if sprName then
               -----------------------    boiler*        ---------------------------
               if MoonshineDistillery.isBoilerTile(sprName) then
                  if  MoonshineDistillery.isCompleteParts(obj) then
                     isntopt:setOptionChecked(installMenu, true)
                  end
                  isBoilerTile = true
                  local fake = isntopt:addOptionOnTop('Boiler', worldobjects, nil)
                  fake.notAvailable = true
                  local tip01 = ISWorldObjectContextMenu.addToolTip()

                  isntopt:setOptionChecked(fake, true)
                  fake.iconTexture = getTexture("media/textures/Item_MoonshineBoiler.png")
                  tip01.description = "Already Installed"
                  fake.toolTip = tip01
                  -----------------------            ---------------------------
                  local fake2 = isntopt:addOptionOnTop('Thumper', worldobjects, nil)
                  fake2.notAvailable = true
                  local tip02 = ISWorldObjectContextMenu.addToolTip()

                  isntopt:setOptionChecked(fake2, true)
                  tip02.description = "Already Installed"
                  fake2.iconTexture = getTexture("media/textures/Item_MoonshineThumper.png")
                  fake2.toolTip = tip02

                  -----------------------            ---------------------------
                  local sprName = obj:getSprite():getName()
                  local optTipThermo = isntopt:addOptionOnTop('Thermometer', worldobjects, function()
                     local part = "Thermometer"
                     local item = MoonshineDistillery.getThermometer(pl)
                     if item then
                        local sprToSpawn = MoonshineDistillery.getOverlayToAdd(sprName, part)
                        MoonshineDistillery.spawnPart(sprToSpawn, sq, item, inv)
                     end
                  end)
                  local done1 =  MoonshineDistillery.hasThermometerOverlay(obj)
                  local hasPart1 = MoonshineDistillery.hasStillCapItem(pl)
                  if not hasPart1 or done1 then
                     optTipThermo.notAvailable = true
                  end
                  local tip1 = ISWorldObjectContextMenu.addToolTip()
                  optTipThermo.iconTexture = getTexture("media/textures/Item_MoonshineThermometer.png")
                  if done1 then
                     isntopt:setOptionChecked(optTipThermo, done1)
                     tip1.description = "Already Installed"
                  else
                     if not hasPart1 then
                        tip1.description = "Install Thermometer"
                     end
                  end
                  optTipThermo.toolTip = tip1
                  -----------------------    StillCap*        ---------------------------

                  local optTipSCap = isntopt:addOptionOnTop('Still Cap', worldobjects, function()
                     local part = "StillCap"
                     local sprToSpawn = MoonshineDistillery.getOverlayToAdd(sprName, part)
                     local item = MoonshineDistillery.getStillCap(pl)
                     if item then
                        --MoonshineDistillery.addOverlay(obj, sprName, part, item)
                        MoonshineDistillery.spawnPart(sprToSpawn, sq, item, inv)
                        obj:setIsThumpable(true)
                        obj:setIsContainer(true)
                        obj:setIsDismantable(false)
                        obj:getContainer():setType('Distiller')

                        obj:getContainer():setDrawDirty(true);
                        if isClient() then
                           obj:transmitCompleteItemToServer()
                           obj:transmitUpdatedSpriteToClients()
                        end
                        getPlayerInventory(0):refreshBackpacks()
                        getPlayerLoot(0):refreshBackpacks()
                     end
                  end)
                  local done2 = MoonshineDistillery.hasStillCapOverlay(obj)
                  local hasPart2 = MoonshineDistillery.hasStillCapItem(pl)
                  if not hasPart2 or done2 then
                     optTipSCap.notAvailable = true
                  end
                  local tip2 = ISWorldObjectContextMenu.addToolTip()
                  optTipSCap.iconTexture = getTexture("media/textures/Item_MoonshineStillCap.png")
                  if done2 then
                     isntopt:setOptionChecked(optTipSCap, true)
                     tip2.description = "Already Installed"
                  else
                     if not hasPart2 then
                        tip2.description = "Install Still Cap"
                     end
                  end
                  optTipSCap.toolTip = tip

                  -----------------------    DrainPort*        ---------------------------
                  local x, y, z = round(obj:getX()),  round(obj:getY()),  obj:getZ()
                  local sq2 =  MoonshineDistillery.getDrainPortSquare(x, y, z, sprName)

                  local optTipDrain = isntopt:addOptionOnTop('Drain Port', worldobjects, function()
                     local item = MoonshineDistillery.getDrainPort(pl)
                     if item then
                        MoonshineDistillery.setDrainPort(sq2, sprName)
                        MoonshineDistillery.delInvItem(item, inv)
                     end
                  end)
                  local done3 = MoonshineDistillery.hasDrainPortOverlay(sq2)
                  local hasPart3 MoonshineDistillery.hasDrainPortItem(pl)
                  if not hasPart3 or done3 or not sq2 then
                     optTipDrain.notAvailable = true
                  end
                  local tip3 = ISWorldObjectContextMenu.addToolTip()
                  optTipDrain.iconTexture = getTexture("media/textures/Item_MoonshineDrainPort.png")
                  if done3 then
                     isntopt:setOptionChecked(optTipDrain, true)
                     tip3.description = "Already Installed"
                  else
                     if not hasPart3 then
                        tip3.description = "Install Drain Port"
                     end
                  end
                  optTipDrain.toolTip = tip



            -----------------------            ---------------------------

               end--isBoiler
            end --sprName
         end --spr
         -----------------------            ---------------------------
      end --for
   end --checkDist

   -----------------------            ---------------------------



   if (getCore():getDebug() and isAdmin()) then
      if isBoilerTile  then print("isBoilerTile ") end
   end

   -----------------------            ---------------------------
end


Events.OnFillWorldObjectContextMenu.Remove(MoonshineDistillery.DistillerContext)
Events.OnFillWorldObjectContextMenu.Add(MoonshineDistillery.DistillerContext)

function MoonshineDistillery.hasMashBasePlaced(cont)
   return cont:FindAndReturn("MoonDist.MoonshineMashBaseClear") or cont:FindAndReturn("MoonDist.MoonshineMashBaseApple") or cont:FindAndReturn("MoonDist.MoonshineMashBasePeach")
end
-----------------------            ---------------------------
--[[
obj:getModData()[''] =
if isClient() then
   obj:transmitCompleteItemToServer()
   obj:transmitUpdatedSpriteToClients()
end
obj:transmitModData()
]]
-----------------------            ---------------------------

--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													                   |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							                |
|                       		                                    														 	                   |
|                       	Discord:    Glytch3r#1337 / glytch3r															                      |
|                       		                                    													                  	 	 |
|                       	Support:    https://ko-fi.com/glytch3r														                      	 |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

MoonshineDistillery = MoonshineDistillery or {}

MoonshineDistillery.flavors = {"Clear","Apple","Peach"}

function MoonshineDistillery.getDistillerTimer()
   return SandboxVars.MoonshineDistillery.FermentationMinutes or 120
end



function MoonshineDistillery.setSprite(obj, sprName)
   obj:setSprite(sprName)
   obj:getSprite():setName(sprName)
   local cont = obj:getContainer()
   if cont then
      cont:setDrawDirty(true)
   end
   ISInventoryPage.renderDirty = true
   if isClient() then
      obj:transmitCompleteItemToServer()
      obj:transmitUpdatedSpriteToClients()
   end
   getPlayerInventory(0):refreshBackpacks()
   getPlayerLoot(0):refreshBackpacks()

end



function MoonshineDistillery.delItem(cont, fType, qty)
    qty = qty or 1
    local count = cont:getItemCount(fType)
    --local count = item:getContainer():getNumberOfItem(fType)
    if count >= qty then
        for i=1, qty do
            local item = contInv:FindAndReturn(fType)
            if item then
                if isClient() then
                    cont:removeItemOnServer(item)
                end
                cont:DoRemoveItem(item)
            end
        end
        getPlayerLoot(0):refreshBackpacks()
    end
end

function MoonshineDistillery.context(player, context, worldobjects, test)
   local pl = getSpecificPlayer(player)
   local inv = pl:getInventory()
   local sq = clickedSquare
   if not MoonshineDistillery.isLearned(pl) then return end
   if sq then
      if MoonshineDistillery.CanPlace(pl) then
         local Main = context:addOptionOnTop("Build Moonshine Distiller: ")
         Main.iconTexture = getTexture("media/ui/Moonshine.png")
         local opt = ISContextMenu:getNew(context)
         context:addSubMenu(Main, opt)



         local sOpt = opt:addOption('South', worldobjects, function()
            local cursor = ISMoonshineTileCursor:new("MoonshineDistillery_16",  pl, sq)
            getCell():setDrag(cursor, 0)
            ISMoveableCursor.clearCacheForAllPlayers();
         end)

         local tip = ISWorldObjectContextMenu.addToolTip()
         tip.description = "Moonshine Distiller South"
         local iconPath = "media/ui/MoonshineDistillerEast.png"
         sOpt.iconTexture = getTexture(iconPath)
         --tip:setTexture(iconPath)
         sOpt.toolTip = tip

         local eOpt = opt:addOption('East', worldobjects, function()
            local cursor = ISMoonshineTileCursor:new("MoonshineDistillery_27",  pl, sq)
            getCell():setDrag(cursor, 0)
            ISMoveableCursor.clearCacheForAllPlayers();
         end)

         local tip = ISWorldObjectContextMenu.addToolTip()
         tip.description = "Moonshine Distiller East"
         local iconPath = "media/ui/MoonshineDistillerEast.png"
         eOpt.iconTexture = getTexture(iconPath)
         --tip:setTexture(iconPath)
         eOpt.toolTip = tip

      end

      for i=0, sq:getObjects():size()-1 do
         local obj = sq:getObjects():get(i)
         local spr = obj:getSprite()
         if spr then
            local sprName = spr:getName()
            if sprName then

               -----------------------    boiler*        ---------------------------
               if MoonshineDistillery.isBoilerTile(sprName) then

                  local installMenu = context:addOptionOnTop("Install Parts")
                  installMenu.iconTexture = getTexture("media/ui/MoonshineInstall.png")
                  local opt = ISContextMenu:getNew(context)
                  context:addSubMenu(installMenu, opt)

                  if MoonshineDistillery.checkDist(pl, sq) then
                     if not MoonshineDistillery.hasThermometerOverlay(obj) then
                        local optTip = opt:addOptionOnTop('Thermometer', worldobjects, function()
                           local part = "Thermometer"
                           local item = MoonshineDistillery.getThermometer(pl)
                           if item then
                              local sprToSpawn = MoonshineDistillery.getOverlayToAdd(sprName, part)
                              MoonshineDistillery.spawnPart(sprToSpawn, sq, item, inv)
                           end
                        end)
                        if not MoonshineDistillery.hasThermometerItem(pl) then
                           optTip.notAvailable = true
                        end
                     end


                     if not MoonshineDistillery.hasStillCapOverlay(obj) then
                        local optTip = opt:addOptionOnTop('Still Cap', worldobjects, function()
                           local part = "StillCap"
                           local sprToSpawn = MoonshineDistillery.getOverlayToAdd(sprName, part)
                           local item = MoonshineDistillery.getStillCap(pl)
                           if item then
                              --MoonshineDistillery.addOverlay(obj, sprName, part, item)
                              MoonshineDistillery.spawnPart(sprToSpawn, sq, item, inv)
                              obj:setIsThumpable(true)
                              obj:setIsContainer(true)
                              obj:setIsDismantable(false)
                              obj:getContainer():setType('Distiller')

                              obj:getContainer():setDrawDirty(true);
                              if isClient() then
                                 obj:transmitCompleteItemToServer()
                                 obj:transmitUpdatedSpriteToClients()
                              end
                              getPlayerInventory(0):refreshBackpacks()
                              getPlayerLoot(0):refreshBackpacks()
                           end
                        end)
                        if not MoonshineDistillery.hasStillCapItem(pl) then
                           optTip.notAvailable = true
                        end
                     end


                     local x, y, z = round(obj:getX()),  round(obj:getY()),  obj:getZ()
                     local sq2 =  MoonshineDistillery.getDrainPortSquare(x, y, z, sprName)
                     if sq2 and not MoonshineDistillery.hasDrainPortOverlay(sq2) then
                        if sq2 and sq2:getFloor() then  sq2:getFloor():setHighlighted(true, true) end
                        local optTip = opt:addOptionOnTop('Drain Port', worldobjects, function()
                           local item = MoonshineDistillery.getDrainPort(pl)
                           if item then
                              MoonshineDistillery.setDrainPort(sq2, sprName)
                              MoonshineDistillery.delPart(item, inv)
                           end
                        end)
                        if not MoonshineDistillery.hasDrainPortItem(pl) then
                           optTip.notAvailable = true
                        end
                     end

                  end
               end
               --print(MoonshineDistillery.isCampfire(sprName))
               -----------------------    campfire*        ---------------------------
               if MoonshineDistillery.isCampfire(sprName) then
                  if MoonshineDistillery.checkDist(pl, sq) then
                     if not MoonshineDistillery.hasCookingVat(sq) then
                        context:addOptionOnTop('Build Cooking Vat', worldobjects, function()
                           local item = MoonshineDistillery.getMetalDrum(pl)
                           if item then
                              if getCore():getDebug() then
                                 print("Debug mode bypassed MetalDrum Removal")
                              else
                                 inv:Remove(item)
                              end
                              local toSpawn = IsoThumpable.new(getCell(), sq, "MoonshineDistillery_0", false, nil);
                              sq:AddTileObject(toSpawn);
                              toSpawn:setIsContainer(true);
                              toSpawn:getContainer():setType('CookingVat')
                              getPlayerInventory(0):refreshBackpacks()
                              getPlayerLoot(0):refreshBackpacks()
                              toSpawn:getContainer():setDrawDirty(true);
                           end
                        end)
                     end
                  end
               end
               -----------------------   cookingVat*        ---------------------------

               if MoonshineDistillery.isCookingVat(sprName) then
                  local cookvatmenu = context:addOptionOnTop("Cooking Vat:")
                  cookvatmenu.iconTexture = getTexture("media/ui/MoonshineMashBase.png")
                  local opt = ISContextMenu:getNew(context)
                  context:addSubMenu(cookvatmenu, opt)

                  if MoonshineDistillery.checkDist(pl, sq) then
                     local stage = MoonshineDistillery.getStage(sprName)

                     local optTip = opt:addOptionOnTop('Add Water', worldobjects, function()
                        MoonshineDistillery.setStage(obj, "water")
                     end)
                     if stage ~= "empty" then optTip.notAvailable = true end

                     local waterMenu = opt:addOptionOnTop("Add Mash Base")
                     waterMenu.iconTexture = getTexture("media/ui/MoonshineMashBase.png")
                     local optMash = ISContextMenu:getNew(context)
                     context:addSubMenu(waterMenu, optMash)
                     local cont = obj:getContainer()

                     if cont and MoonshineDistillery.hasMashBasePlaced(cont) then
                        local addClear = optMash:addOptionOnTop('Clear Base', worldobjects, function()
                           MoonshineDistillery.delPart(clearbase, inv)
                           MoonshineDistillery.setStage(obj, "mash")
                           getSoundManager():playUISound("UIActivateMainMenuItem")
                        end)

                        local addApple = optMash:addOptionOnTop('Apple Base', worldobjects, function()
                           MoonshineDistillery.delPart(applebase, inv)
                           MoonshineDistillery.setStage(obj, "mash")
                           getSoundManager():playUISound("UIActivateMainMenuItem")
                        end)

                        local addPeach = optMash:addOptionOnTop('Peach Base', worldobjects, function()
                           MoonshineDistillery.delPart(peachbase, inv)
                           MoonshineDistillery.setStage(obj, "mash")
                           getSoundManager():playUISound("UIActivateMainMenuItem")
                        end)

                        if stage ~= "water" then
                           addClear.notAvailable = true
                           addApple.notAvailable = true
                           addPeach.notAvailable = true
                        else
                           if not cont:FindAndReturn("MoonDist.MoonshineMashBaseClear") then addClear.notAvailable = true end
                           if not cont:FindAndReturn("MoonDist.MoonshineMashBaseApple") then addApple.notAvailable = true end
                           if not cont:FindAndReturn("MoonDist.MoonshineMashBasePeach") then addPeach.notAvailable = true end
                        end
                     end

                    if stage == "mash" then
                        context:addOptionOnTop('Prepare Moonshine Process', worldobjects, function()
                           MoonshineDistillery.setStage(obj, "cooking")
                           MoonshineDistillery.setTimeStamp(obj)
                           getSoundManager():playUISound("UIActivateMainMenuItem")
                        end)
                     elseif stage == "cooking" then
                        local eta = MoonshineDistillery.getRemainingHours(obj)
                        local cookOpt = context:addOptionOnTop('Process Moonshine', worldobjects, function()
                           getSoundManager():playUISound("UIActivateMainMenuItem")
                        end)
                        cookOpt.toolTip = ISToolTip:new()
                        cookOpt.toolTip:initialise()
                        cookOpt.toolTip:setVisible(true)
                        cookOpt.toolTip.description = "Remaining time: " .. (eta and math.floor(eta) or "Unknown") .. " hours"
                     elseif stage == "unfermented" then
                        context:addOptionOnTop('Filter Moonshine Mash', worldobjects, function()
                           MoonshineDistillery.setStage(obj, "empty")  -- Reset after filtering
                           getSoundManager():playUISound("UIActivateMainMenuItem")
                        end)
                     end
                  end
               end
               -----------------------            ---------------------------
            end
         end
      end
   end
end


Events.OnFillWorldObjectContextMenu.Remove(MoonshineDistillery.context)
Events.OnFillWorldObjectContextMenu.Add(MoonshineDistillery.context)

-----------------------            ---------------------------


-----------------------            ---------------------------

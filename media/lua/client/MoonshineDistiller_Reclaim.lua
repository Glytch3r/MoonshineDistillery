--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


MoonshineDistillery = MoonshineDistillery or {}


-----------------------            ---------------------------

--triggerEvent("OnObjectAboutToBeRemoved", dbgIso)


-----------------------            ---------------------------
MoonshineDistilleryReclaim = ISBaseTimedAction:derive("MoonshineDistilleryReclaim")

function MoonshineDistilleryReclaim:isValid()
    return self.sq ~= nil
end

function MoonshineDistilleryReclaim:update()
    self.character:faceThisObject(self.part)
	return self.character:shouldBeTurning()
end


function MoonshineDistilleryReclaim:start()
    self:setActionAnim("Loot")
    self.character:SetVariable("LootPosition", "Low")
    self.sound = self.character:playSound("RemoveBarricadeMetal")
end

function MoonshineDistilleryReclaim:stop()
    if self.sound then
        self.character:getEmitter():stopSound(self.sound)
    end
    ISBaseTimedAction.stop(self)
end

function MoonshineDistilleryReclaim:perform()
    if self.sound then
        self.character:getEmitter():stopSound(self.sound)
        self.sound = nil
    end
    MoonshineDistillery.doSledge(self.part)
    ISBaseTimedAction.perform(self)
end


function MoonshineDistilleryReclaim:new(character, sq, part)
    local o = {}
    setmetatable(o, self)
    self.__index = self
    o.character = character
    o.sq = sq
    o.part = part
    o.stopOnWalk = true
    o.stopOnRun = true
    o.maxTime = 100
    return o
end

function MoonshineDistillery.doReclaim(part)
    if not part then return end
    local pl = getPlayer()
    local sq = part:getSquare();
    if not pl or not sq then return end
    if luautils.walkAdj(pl, sq) then
        ISTimedActionQueue.add(MoonshineDistilleryReclaim:new(pl, sq, part));
    end
end
-----------------------            ---------------------------

function MoonshineDistillery.doSledge(obj)
    if isClient() then
        sledgeDestroy(obj)
    else
        local sq = obj:getSquare()
        if sq then
            sq:RemoveTileObject(obj);
            sq:getSpecialObjects():remove(obj);
            sq:getObjects():remove(obj);
            sq:transmitRemoveItemFromSquare(obj)
        end
    end
end



-----------------------            ---------------------------
function MoonshineDistillery.getPartsFromBoiler(boiler, part)
    if not boiler then return nil end
    local spr = boiler:getSprite()
    if not spr then return nil end
    local sprName = spr:getName()
    if not sprName then return nil end

    local offsets = {
        ["MoonshineDistillery_16"] = {
            Thermometer = {0, 0, "MoonshineDistillery_21"},
            StillCap = {0, 0, "MoonshineDistillery_20"},
            DrainPort = {1, -1, "MoonshineDistillery_22"},
            Distiller = {
                {0, 0, "MoonshineDistillery_16"},
                {1, 0, "MoonshineDistillery_17"},
                {1, -1, "MoonshineDistillery_18"},
                {1, -1, "MoonshineDistillery_19"}
            }
        },
        ["MoonshineDistillery_27"] = {
            Thermometer = {0, 0, "MoonshineDistillery_29"},
            StillCap = {0, 0, "MoonshineDistillery_28"},
            DrainPort = {-1, 1, "MoonshineDistillery_30"},
            Distiller = {
                {0, 0, "MoonshineDistillery_27"},
                {0, 1, "MoonshineDistillery_26"},
                {-1, 1, "MoonshineDistillery_25"},
                {-1, 1, "MoonshineDistillery_24"}
            }
        }
    }

    local partData = offsets[sprName]
    if not partData then return nil end

    if part == "Distiller" then
        local miscPartsExist = false
        for _, miscPart in ipairs({"Thermometer", "StillCap", "DrainPort"}) do
            local miscObj = MoonshineDistillery.getPartsFromBoiler(boiler, miscPart)
            if miscObj then
                miscPartsExist = true
                break
            end
        end

        if not miscPartsExist then
            local objects = {}
            for _, data in ipairs(partData.Distiller) do
                local sq = getCell():getGridSquare(boiler:getSquare():getX() + data[1], boiler:getSquare():getY() + data[2], boiler:getSquare():getZ())
                if sq then
                    for i = 0, sq:getObjects():size() - 1 do
                        local obj = sq:getObjects():get(i)
                        if obj:getSprite() and obj:getSprite():getName() == data[3] then
                            table.insert(objects, obj)
                        end
                    end
                end
            end
            return #objects > 0 and objects or nil
        end
    else
        local pos = partData[part]
        if not pos then return nil end
        local sq = getCell():getGridSquare(boiler:getSquare():getX() + pos[1], boiler:getSquare():getY() + pos[2], boiler:getSquare():getZ())
        if not sq then return nil end

        for i = 0, sq:getObjects():size() - 1 do
            local obj = sq:getObjects():get(i)
            if obj:getSprite() and obj:getSprite():getName() == pos[3] then
                return obj
            end
        end
    end

    return nil
end




-----------------------            ---------------------------

--[[

function MoonshineDistillery.ReclaimContext(player, context, worldobjects, test)
    local pl = getSpecificPlayer(player)
    local sq = clickedSquare
    if not MoonshineDistillery.isLearned(pl) or not sq then return end

    local hasMiscParts, hasDistiller = MoonshineDistillery.checkParts(sq)
    if not hasMiscParts and not hasDistiller then return end

    if hasMiscParts then
        context:addOption("Remove Parts", worldobjects, function()
            ISTimedActionQueue.add(MoonshineDistilleryReclaim:new(pl, sq, "misc"))
        end)
    end

    if not hasMiscParts and hasDistiller then
        context:addOption("Reclaim Distiller", worldobjects, function()
            ISTimedActionQueue.add(MoonshineDistilleryReclaim:new(pl, sq, "distiller"))
        end)
    end
end
 ]]
function MoonshineDistillery.checkParts(sq)
    local offsets = {
        ["MoonshineDistillery_16"] = {
            Thermometer = {0, 0, "MoonshineDistillery_21"},
            StillCap = {0, 0, "MoonshineDistillery_20"},
            DrainPort = {1, -1, "MoonshineDistillery_22"},
            Distiller = {
                {0, 0, "MoonshineDistillery_16"},
                {1, 0, "MoonshineDistillery_17"},
                {1, -1, "MoonshineDistillery_18"},
                {1, -1, "MoonshineDistillery_19"}
            }
        },
        ["MoonshineDistillery_27"] = {
            Thermometer = {0, 0, "MoonshineDistillery_29"},
            StillCap = {0, 0, "MoonshineDistillery_28"},
            DrainPort = {-1, 1, "MoonshineDistillery_30"},
            Distiller = {
                {0, 0, "MoonshineDistillery_27"},
                {0, 1, "MoonshineDistillery_26"},
                {-1, 1, "MoonshineDistillery_25"},
                {-1, 1, "MoonshineDistillery_24"}
            }
        }
    }

    local miscParts = {}
    local distillerParts = {}

    for boilerTile, parts in pairs(offsets) do
        for _, offset in ipairs(parts.Distiller) do
            local x, y = sq:getX() + offset[1], sq:getY() + offset[2]
            local obj = getCell():getGridSquare(x, y, sq:getZ())
            if obj then
                for i = 0, obj:getObjects():size() - 1 do
                    local item = obj:getObjects():get(i)
                    local spr = item:getSprite()
                    if spr and spr:getName() == offset[3] then
                        table.insert(distillerParts, item)
                    end
                end
            end
        end

        for part, offset in pairs(parts) do
            if part ~= "Distiller" then
                local x, y = sq:getX() + offset[1], sq:getY() + offset[2]
                local obj = getCell():getGridSquare(x, y, sq:getZ())
                if obj then
                    for i = 0, obj:getObjects():size() - 1 do
                        local item = obj:getObjects():get(i)
                        local spr = item:getSprite()
                        if spr and spr:getName() == offset[3] then
                            miscParts[part] = item
                        end
                    end
                end
            end
        end
    end

    return (tableSize(miscParts) > 0), #distillerParts > 0
end










local thumperList = {
    ["MoonshineDistillery_17"] = true,
    ["MoonshineDistillery_18"] = true,
    ["MoonshineDistillery_26"] = true,
    ["MoonshineDistillery_25"] = true,

}
local canCondenserList = {
    ["MoonshineDistillery_19"] = true,
    ["MoonshineDistillery_24"] = true,

}



function MoonshineDistillery.DistillerReclaimContext(player, context, worldobjects, test)
    local pl = getSpecificPlayer(player)
    local sq = clickedSquare
    --if not MoonshineDistillery.isLearned(pl) or not sq then return end

    local thumper, boiler, canCondenser = nil, nil, nil
    for i = 0, sq:getObjects():size() - 1 do
        local obj = sq:getObjects():get(i)
        local sprName = obj:getSprite() and obj:getSprite():getName() or nil
        if sprName then
            if thumperList[sprName] then thumper = obj end
            if canCondenserList[sprName] then canCondenser = obj end
            if MoonshineDistillery.isBoilerTile(sprName) then
                boiler = obj
            elseif luautils.stringStarts(sprName, "MoonshineDistillery") then
                boiler = MoonshineDistillery.getBoilerObj(sq, sprName)
            end
        end
    end
    if not boiler then return end

    local brkMenu = context:addOptionOnTop("Reclaim Distiller Parts")
    brkMenu.iconTexture = getTexture("media/ui/MoonshineReclaim.png")
    local brkOpt = ISContextMenu:getNew(context)
    context:addSubMenu(brkMenu, brkOpt)

    local function addReclaimOption(name, obj, icon)
        local option = brkOpt:addOption(name, worldobjects, function() MoonshineDistillery.doReclaim(obj) end)
        if not obj then option.notAvailable = true end
        option.iconTexture = getTexture(icon)
    end

    addReclaimOption("Can Condenser", canCondenser, "media/textures/Item_MoonshineBoiler.png")
    addReclaimOption("Boiler", boiler, "media/textures/Item_MoonshineBoiler.png")
    addReclaimOption("Thumper", thumper, "media/textures/Item_MoonshineThumper.png")
    addReclaimOption("Thermometer", MoonshineDistillery.getThermometerCapObj(boiler), "media/textures/Item_MoonshineThermometer.png")
    addReclaimOption("Still Cap", MoonshineDistillery.getStillCapObj(boiler), "media/textures/Item_MoonshineStillCap.png")
    addReclaimOption("Drain Port", MoonshineDistillery.getDrainPortObj(boiler), "media/textures/Item_MoonshineDrainPort.png")
--[[
    if not MoonshineDistillery.checkDist(pl, sq) then
        brkMenu.notAvailable = true
    end ]]
end

Events.OnFillWorldObjectContextMenu.Add(MoonshineDistillery.DistillerReclaimContext)




-----------------------            ---------------------------
--[[         offsets = {
            ["MoonshineDistillery_16"] = { -- boiler
                {0, 0, "MoonshineDistillery_20"}, -- StillCap
                {0, 0, "MoonshineDistillery_21"}, -- Thermometer
                {1, -1, "MoonshineDistillery_22"}, -- DrainPort
                {1, 0, "MoonshineDistillery_17"}, -- thumper tall
                {1, -1, "MoonshineDistillery_18"}, -- thumper short
                {1, -1, "MoonshineDistillery_19"}, -- can
            },
            ["MoonshineDistillery_27"] = { -- boiler
                {0, 0, "MoonshineDistillery_28"}, -- StillCap
                {0, 0, "MoonshineDistillery_29"}, -- Thermometer
                {-1, 1, "MoonshineDistillery_30"}, -- DrainPort
                {0, 1, "MoonshineDistillery_26"}, -- thumper tall
                {-1, 1, "MoonshineDistillery_25"}, -- thumper short
                {-1, 1, "MoonshineDistillery_24"}, -- can
            } ]]
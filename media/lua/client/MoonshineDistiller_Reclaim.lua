--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


MoonshineDistillery = MoonshineDistillery or {}


-----------------------            ---------------------------

--triggerEvent("OnObjectAboutToBeRemoved", dbgIso)


-----------------------            ---------------------------
MoonshineDistilleryReclaim = ISBaseTimedAction:derive("MoonshineDistilleryReclaim")

function MoonshineDistilleryReclaim:isValid()
    return self.sq ~= nil
end

function MoonshineDistilleryReclaim:update()
    self.character:faceThisObject(self.part)
	return self.character:shouldBeTurning()
end


function MoonshineDistilleryReclaim:start()
    self:setActionAnim("Loot")
    self.character:SetVariable("LootPosition", "Low")
    self.sound = self.character:playSound("RemoveBarricadeMetal")
end

function MoonshineDistilleryReclaim:stop()
    if self.sound then
        self.character:getEmitter():stopSound(self.sound)
    end
    ISBaseTimedAction.stop(self)
end

function MoonshineDistilleryReclaim:perform()
    if self.sound then
        self.character:getEmitter():stopSound(self.sound)
        self.sound = nil
    end

    MoonshineDistillery.doSledge(self.part)
    ISBaseTimedAction.perform(self)
end


function MoonshineDistilleryReclaim:new(character, sq, part)
    local o = {}
    setmetatable(o, self)
    self.__index = self
    o.character = character
    o.sq = sq
    o.part = part
    o.stopOnWalk = true
    o.stopOnRun = true
    o.maxTime = 100
    return o
end

function MoonshineDistillery.doReclaim(part)
    if not part then return end
    local pl = getPlayer()
    local sq = part:getSquare();
    if not pl or not sq then return end
    if luautils.walkAdj(pl, sq) then
        ISTimedActionQueue.add(MoonshineDistilleryReclaim:new(pl, sq, part));
    end
end
-----------------------            ---------------------------

function MoonshineDistillery.doSledge(obj)
    if isClient() then
        sledgeDestroy(obj)
    else
        local sq = obj:getSquare()
        if sq then
            sq:RemoveTileObject(obj);
            sq:getSpecialObjects():remove(obj);
            sq:getObjects():remove(obj);
            sq:transmitRemoveItemFromSquare(obj)
        end
    end
end



-----------------------            ---------------------------
function MoonshineDistillery.getPartsFromBoiler(boiler, part)
    if not boiler then return nil end
    local spr = boiler:getSprite()
    if not spr then return nil end
    local sprName = spr:getName()
    if not sprName then return nil end

    local offsets = {
        ["MoonshineDistillery_16"] = {
            Thermometer = {0, 0, "MoonshineDistillery_21"},
            StillCap = {0, 0, "MoonshineDistillery_20"},
            DrainPort = {1, -1, "MoonshineDistillery_22"},
            Distiller = {
                {0, 0, "MoonshineDistillery_16"},
                {1, 0, "MoonshineDistillery_17"},
                {1, -1, "MoonshineDistillery_18"},
                {1, -1, "MoonshineDistillery_19"}
            }
        },
        ["MoonshineDistillery_27"] = {
            Thermometer = {0, 0, "MoonshineDistillery_29"},
            StillCap = {0, 0, "MoonshineDistillery_28"},
            DrainPort = {-1, 1, "MoonshineDistillery_30"},
            Distiller = {
                {0, 0, "MoonshineDistillery_27"},
                {0, 1, "MoonshineDistillery_26"},
                {-1, 1, "MoonshineDistillery_25"},
                {-1, 1, "MoonshineDistillery_24"}
            }
        }
    }

    local partData = offsets[sprName]
    if not partData then return nil end

    if part == "Distiller" then
        local miscPartsExist = false
        for _, miscPart in ipairs({"Thermometer", "StillCap", "DrainPort"}) do
            local miscObj = MoonshineDistillery.getPartsFromBoiler(boiler, miscPart)
            if miscObj then
                miscPartsExist = true
                break
            end
        end

        if not miscPartsExist then
            local objects = {}
            for _, data in ipairs(partData.Distiller) do
                local sq = getCell():getGridSquare(boiler:getSquare():getX() + data[1], boiler:getSquare():getY() + data[2], boiler:getSquare():getZ())
                if sq then
                    for i = 0, sq:getObjects():size() - 1 do
                        local obj = sq:getObjects():get(i)
                        if obj:getSprite() and obj:getSprite():getName() == data[3] then
                            table.insert(objects, obj)
                        end
                    end
                end
            end
            return #objects > 0 and objects or nil
        end
    else
        local pos = partData[part]
        if not pos then return nil end
        local sq = getCell():getGridSquare(boiler:getSquare():getX() + pos[1], boiler:getSquare():getY() + pos[2], boiler:getSquare():getZ())
        if not sq then return nil end

        for i = 0, sq:getObjects():size() - 1 do
            local obj = sq:getObjects():get(i)
            if obj:getSprite() and obj:getSprite():getName() == pos[3] then
                return obj
            end
        end
    end

    return nil
end




-----------------------            ---------------------------

--[[

function MoonshineDistillery.ReclaimContext(player, context, worldobjects, test)
    local pl = getSpecificPlayer(player)
    local sq = clickedSquare
    if not MoonshineDistillery.isLearned(pl) or not sq then return end

    local hasMiscParts, hasDistiller = MoonshineDistillery.checkParts(sq)
    if not hasMiscParts and not hasDistiller then return end

    if hasMiscParts then
        context:addOption("Remove Parts", worldobjects, function()
            ISTimedActionQueue.add(MoonshineDistilleryReclaim:new(pl, sq, "misc"))
        end)
    end

    if not hasMiscParts and hasDistiller then
        context:addOption("Reclaim Distiller", worldobjects, function()
            ISTimedActionQueue.add(MoonshineDistilleryReclaim:new(pl, sq, "distiller"))
        end)
    end
end
 ]]
function MoonshineDistillery.checkParts(sq)
    local offsets = {
        ["MoonshineDistillery_16"] = {
            Thermometer = {0, 0, "MoonshineDistillery_21"},
            StillCap = {0, 0, "MoonshineDistillery_20"},
            DrainPort = {1, -1, "MoonshineDistillery_22"},
            Distiller = {
                {0, 0, "MoonshineDistillery_16"},
                {1, 0, "MoonshineDistillery_17"},
                {1, -1, "MoonshineDistillery_18"},
                {1, -1, "MoonshineDistillery_19"}
            }
        },
        ["MoonshineDistillery_27"] = {
            Thermometer = {0, 0, "MoonshineDistillery_29"},
            StillCap = {0, 0, "MoonshineDistillery_28"},
            DrainPort = {-1, 1, "MoonshineDistillery_30"},
            Distiller = {
                {0, 0, "MoonshineDistillery_27"},
                {0, 1, "MoonshineDistillery_26"},
                {-1, 1, "MoonshineDistillery_25"},
                {-1, 1, "MoonshineDistillery_24"}
            }
        }
    }

    local miscParts = {}
    local distillerParts = {}

    for boilerTile, parts in pairs(offsets) do
        for _, offset in ipairs(parts.Distiller) do
            local x, y = sq:getX() + offset[1], sq:getY() + offset[2]
            local obj = getCell():getGridSquare(x, y, sq:getZ())
            if obj then
                for i = 0, obj:getObjects():size() - 1 do
                    local item = obj:getObjects():get(i)
                    local spr = item:getSprite()
                    if spr and spr:getName() == offset[3] then
                        table.insert(distillerParts, item)
                    end
                end
            end
        end

        for part, offset in pairs(parts) do
            if part ~= "Distiller" then
                local x, y = sq:getX() + offset[1], sq:getY() + offset[2]
                local obj = getCell():getGridSquare(x, y, sq:getZ())
                if obj then
                    for i = 0, obj:getObjects():size() - 1 do
                        local item = obj:getObjects():get(i)
                        local spr = item:getSprite()
                        if spr and spr:getName() == offset[3] then
                            miscParts[part] = item
                        end
                    end
                end
            end
        end
    end

    return (tableSize(miscParts) > 0), #distillerParts > 0
end




-----------------------            ---------------------------

MoonshineDistillery.ReclaimTable = {
    ["MoonshineDistillery_16"] = {partName = "Boiler", iconPath = getTexture("media/textures/Item_MoonshineBoiler.png")},
    ["MoonshineDistillery_27"] = {partName = "Boiler", iconPath = getTexture("media/textures/Item_MoonshineBoiler.png")},

    ["MoonshineDistillery_20"] = {partName = "Still Cap", iconPath = getTexture("media/textures/Item_MoonshineStillCap.png")},
    ["MoonshineDistillery_28"] = {partName = "Still Cap", iconPath = getTexture("media/textures/Item_MoonshineStillCap.png")},

    ["MoonshineDistillery_21"] = {partName = "Thermometer", iconPath = getTexture("media/textures/Item_MoonshineThermometer.png")},
    ["MoonshineDistillery_29"] = {partName = "Thermometer", iconPath = getTexture("media/textures/Item_MoonshineThermometer.png")},

    ["MoonshineDistillery_22"] = {partName = "Drain Port", iconPath = getTexture("media/textures/Item_MoonshineDrainPort.png")},
    ["MoonshineDistillery_30"] = {partName = "Drain Port", iconPath = getTexture("media/textures/Item_MoonshineDrainPort.png")},

    ["MoonshineDistillery_17"] = {partName = "Thumper Part", iconPath = getTexture("media/textures/Item_MoonshineThumper.png")},
    ["MoonshineDistillery_18"] = {partName = "Thumper Part", iconPath = getTexture("media/textures/Item_MoonshineThumper.png")},
    ["MoonshineDistillery_26"] = {partName = "Thumper Part", iconPath = getTexture("media/textures/Item_MoonshineThumper.png")},
    ["MoonshineDistillery_25"] = {partName = "Thumper Part", iconPath = getTexture("media/textures/Item_MoonshineThumper.png")},

    ["MoonshineDistillery_19"] = {partName = "Can Condenser", iconPath = getTexture("media/ui/MoonshineCan.png")},
    ["MoonshineDistillery_24"] = {partName = "Can Condenser", iconPath = getTexture("media/ui/MoonshineCan.png")},


    ["MoonshineDistillery_0"] = {partName = "Empty Cooking Vat", iconPath = getTexture("media/textures/Item_CookingVat.png")},
    ["MoonshineDistillery_1"] = {partName = "Cooking Vat With Water", iconPath = getTexture("media/textures/Item_CookingVat.png")},
    ["MoonshineDistillery_2"] = {partName = "Cooking Vat With Mash", iconPath = getTexture("media/textures/Item_CookingVat.png")},
    ["MoonshineDistillery_3"] = {partName = "Cooking Vat With Unfermented Moonshine", iconPath = getTexture("media/textures/Item_CookingVat.png")},
    ["MoonshineDistillery_4"] = {partName = "Active Cooking Vat", iconPath = getTexture("media/textures/Item_CookingVat.png")},

}



-----------------------            ---------------------------


function MoonshineDistillery.DistillerReclaimContext(player, context, worldobjects, test)
    local pl = getSpecificPlayer(player)
    local sq = clickedSquare
    --if not MoonshineDistillery.isLearned(pl) or not sq then return end


    local menuName = "Reclaim: "
    local brkMenu = context:addOptionOnTop(menuName)
    brkMenu.iconTexture = getTexture("media/ui/MoonshineReclaim.png")
    local brkOpt = ISContextMenu:getNew(context)
    context:addSubMenu(brkMenu, brkOpt)

    local function addReclaimOption(partName, obj, iconPath, desc)
        local optTip = brkOpt:addOption(tostring(partName), worldobjects, function()
            MoonshineDistillery.doReclaim(obj)
            context:hideAndChildren()
        end)
        optTip.iconTexture = iconPath
        if not obj then
            optTip.notAvailable = true
            if desc then
                local tip = ISWorldObjectContextMenu.addToolTip()
                tip.description = desc
                optTip.toolTip = tip
            end
        end
    end
    local shouldBeAvailable = false
    for i = 0, sq:getObjects():size() - 1 do
        local obj = sq:getObjects():get(i)
        local sprName = obj:getSprite() and obj:getSprite():getName() or nil
        if sprName and luautils.stringStarts(sprName, "MoonshineDistillery") then
            local data = MoonshineDistillery.ReclaimTable[sprName]
            if data then
                addReclaimOption(data.partName, obj, data.iconPath, "Reclaim " .. data.partName)
                shouldBeAvailable = true
            end
        end
    end

    if not shouldBeAvailable then
        context:removeOptionByName(menuName)
    end

end
Events.OnFillWorldObjectContextMenu.Add(MoonshineDistillery.DistillerReclaimContext)

-----------------------            ---------------------------





-----------------------            ---------------------------

--[[

function MoonshineDistillery.DistillerReclaimContext(player, context, worldobjects, test)
    local pl = getSpecificPlayer(player)
    local sq = clickedSquare
    --if not MoonshineDistillery.isLearned(pl) or not sq then return end

    local thumper, boiler, canCondenser = nil, nil, nil
    for i = 0, sq:getObjects():size() - 1 do
        local obj = sq:getObjects():get(i)
        local sprName = obj:getSprite() and obj:getSprite():getName() or nil
        if sprName then
            if MoonshineDistillery.thumperList[sprName] then thumper = obj end
            if MoonshineDistillery.canCondenserList[sprName] then canCondenser = obj end
            if MoonshineDistillery.isBoilerTile(sprName) then
                boiler = obj
            elseif luautils.stringStarts(sprName, "MoonshineDistillery") then
                boiler = MoonshineDistillery.getBoilerObj(sq, sprName)
            end
        end
    end
    --if not boiler then return end

    local brkMenu = context:addOptionOnTop("Reclaim Distiller Parts")
    brkMenu.iconTexture = getTexture("media/ui/MoonshineReclaim.png")
    local brkOpt = ISContextMenu:getNew(context)
    context:addSubMenu(brkMenu, brkOpt)

    local function addReclaimOption(name, obj, icon, desc)
        local optTip = brkOpt:addOption(name, worldobjects, function() MoonshineDistillery.doReclaim(obj) end)
        optTip.iconTexture = getTexture(icon)
        if not obj then
            optTip.notAvailable = true
            if desc then
                local tip = ISWorldObjectContextMenu.addToolTip()
                tip.description = tostring(desc) or ""
                optTip.toolTip = tip
            end
        end

    end




    addReclaimOption("Can Condenser", canCondenser, "media/textures/Item_MoonshineBoiler.png", )
    addReclaimOption("Boiler", boiler, "media/textures/Item_MoonshineBoiler.png")
    addReclaimOption("Thumper", thumper, "media/textures/Item_MoonshineThumper.png")
    addReclaimOption("Thermometer", MoonshineDistillery.getThermometerCapObj(boiler), "media/textures/Item_MoonshineThermometer.png")
    addReclaimOption("Still Cap", MoonshineDistillery.getStillCapObj(boiler), "media/textures/Item_MoonshineStillCap.png")
    addReclaimOption("Drain Port", MoonshineDistillery.getDrainPortObj(boiler), "media/textures/Item_MoonshineDrainPort.png")

end


 ]]



--[[
    local recopt = cookopt:addOptionOnTop("Reclaim Barrel", worldobjects, function()
    local fType = cookingVat:getModData()['itemFullType'] or "Base.MetalDrum"
        local item = InventoryItemFactory.CreateItem(fType);
        sq:AddWorldInventoryItem(item, 0.5, 0.5, 0);
        MoonshineDistillery.doSledge(cookingVat)

        MoonshineDistillery.doReclaim(cookingVat)

        ISInventoryPage.dirtyUI();
        context:hideAndChildren()
    end)
    if checkDist then
        recopt.notAvailable = true
    end
--]]
-----------------------            ---------------------------
--[[         offsets = {
            ["MoonshineDistillery_16"] = { -- boiler
                {0, 0, "MoonshineDistillery_20"}, -- StillCap
                {0, 0, "MoonshineDistillery_21"}, -- Thermometer
                {1, -1, "MoonshineDistillery_22"}, -- DrainPort
                {1, 0, "MoonshineDistillery_17"}, -- thumper tall
                {1, -1, "MoonshineDistillery_18"}, -- thumper short
                {1, -1, "MoonshineDistillery_19"}, -- can
            },
            ["MoonshineDistillery_27"] = { -- boiler
                {0, 0, "MoonshineDistillery_28"}, -- StillCap
                {0, 0, "MoonshineDistillery_29"}, -- Thermometer
                {-1, 1, "MoonshineDistillery_30"}, -- DrainPort
                {0, 1, "MoonshineDistillery_26"}, -- thumper tall
                {-1, 1, "MoonshineDistillery_25"}, -- thumper short
                {-1, 1, "MoonshineDistillery_24"}, -- can
            } ]]
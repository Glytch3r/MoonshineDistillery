--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


MoonshineDistillery = MoonshineDistillery or {}
-----------------------            ---------------------------
function MoonshineDistillery.loadCursor()
   ISMoonshineTileCursor = ISBuildingObject:derive("ISMoonshineTileCursor")

   function ISMoonshineTileCursor:create(x, y, z, sprite)
      local pl = getPlayer()
      local positions = {}
      if sprite == "MoonshineDistillery_16" then
         positions = {
               {x, y, z, "MoonshineDistillery_16"},
               {x + 1, y, z, "MoonshineDistillery_17"},
               {x + 1, y - 1, z, "MoonshineDistillery_18"},
               {x + 2, y - 1, z, "MoonshineDistillery_19"}
         }
      else
         positions = {
               {x, y, z, "MoonshineDistillery_27"},
               {x, y + 1, z, "MoonshineDistillery_26"},
               {x - 1, y + 1, z, "MoonshineDistillery_25"},
               {x - 1, y + 1, z, "MoonshineDistillery_24"}
         }
      end
      local firstSq = getCell():getOrCreateGridSquare(x, y, z);
      if not MoonshineDistillery.checkDist(pl, firstSq) then
         pl:setHaloNote(tostring("Need to get closer"),150,250,150,900)
         return
      end
      for _, pos in ipairs(positions) do
         local square = getCell():getGridSquare(pos[1], pos[2], pos[3])
         if not square or not square:isFree(false) then
            pl:setHaloNote(tostring("Cannot place there"),150,250,150,900)
            return
         end
      end



      for _, pos in ipairs(positions) do
         local square = getCell():getGridSquare(pos[1], pos[2], pos[3])
         if square then
            local props = ISMoveableSpriteProps.new(IsoObject.new(square, pos[4]):getSprite())
            props.rawWeight = 10
            props:placeMoveableInternal(square, InventoryItemFactory.CreateItem("Base.Plank"), pos[4])
            addSound(pl, square:getX(), square:getY(), square:getZ(), 5, 1)
            getSoundManager():PlayWorldSound('MoonshineBuild', square, 0, 5, 5, false)
         end
      end


   end

   function ISMoonshineTileCursor:render(x, y, z, square)
      ISBuildingObject.render(self, x, y, z, square)
   end

   function ISMoonshineTileCursor:new(sprite, character, firstSq)
      local o = {}
      setmetatable(o, self)
      self.__index = self
      o:init()
      o:setSprite(sprite)
      o.character = character
      o.player = character:getPlayerNum()
      o.isTileCursor = true
      o.spriteName = sprite
      o.noNeedHammer = true
      o.skipBuildAction = false
      o.skipWalk2 = false
      o.canBeAlwaysPlaced = true
      return o
   end
end
Events.OnCreatePlayer.Add(MoonshineDistillery.loadCursor)
--   MoonshineDistillery.loadCursor()
-----------------------            ---------------------------
function MoonshineDistillery.CanPlace(pl)
   local inv = pl:getInventory()
   return inv:contains("MoonDist.Boiler") and inv:contains("MoonDist.Thumper")-- and inv:contains("MetalDrum")
end
-----------------------
function MoonshineDistillery.hasThermometer(pl)
   local inv = pl:getInventory()
   return inv:contains("MoonDist.Thermometer")
end
function MoonshineDistillery.hasDrainPort(pl)
   local inv = pl:getInventory()
   return inv:contains("MoonDist.DrainPort")
end
function MoonshineDistillery.hasStillCap(pl)
   local inv = pl:getInventory()
   return inv:contains("MoonDist.StillCap")
end
-----------------------
function MoonshineDistillery.hasMetalDrum(pl)
   local inv = pl:getInventory()
   return inv:contains("Base.MetalDrum") or inv:contains("Moveables.industry_01_22") or inv:contains("Moveables.industry_01_23")
end
-----------------------            ---------------------------
function MoonshineDistillery.getThermometer(pl)
   local inv = pl:getInventory()
   return inv:FindAndReturn("MoonDist.Thermometer")
end
function MoonshineDistillery.getDrainPort(pl)
   local inv = pl:getInventory()
   return inv:FindAndReturn("MoonDist.DrainPort")
end
function MoonshineDistillery.getStillCap(pl)
   local inv = pl:getInventory()
   return inv:FindAndReturn("MoonDist.StillCap")
end


function MoonshineDistillery.delBuildItems(pl)
   local inv = pl:getInventory()
   local delCount = 0
   local item1 = inv:FindAndReturn("MoonDist.Thumper")
   if item1 then
      inv:Remove(item1)
      delCount = delCount + 1
   end
   local item2 = inv:FindAndReturn("MoonDist.Boiler")
   if item2 then
      inv:Remove(item2)
      delCount = delCount + 1
   end
   getPlayerInventory(0):refreshBackpacks()
   getPlayerLoot(0):refreshBackpacks()
   if delCount == 2 then
      return true
   end
   return false
end

-----------------------
function MoonshineDistillery.getMetalDrum(pl)
   local inv = pl:getInventory()
   return inv:FindAndReturn("MetalDrum") or inv:FindAndReturn("Moveables.industry_01_22") or inv:FindAndReturn("Moveables.industry_01_23")
end
-----------------------            ---------------------------
MoonshineDistillery.addParts = {
   ["MoonshineDistillery_16"] = {["StillCap"] = "MoonshineDistillery_20", ["Thermometer"] = "MoonshineDistillery_21"},
   ["MoonshineDistillery_27"] = {["StillCap"] = "MoonshineDistillery_28", ["Thermometer"] = "MoonshineDistillery_29"},
   ["MoonshineDistillery_19"] = {["DrainPort"]= "MoonshineDistillery_22"},
   ["MoonshineDistillery_24"] = {["DrainPort"]= "MoonshineDistillery_30"},
}

function MoonshineDistillery.getOverlayToAdd(sprName, part)
   return MoonshineDistillery.addParts[sprName][part]
end
function MoonshineDistillery.addOverlay(obj, sprName, part, item)
   if not (obj or sprName) then return end
   local overlay = MoonshineDistillery.getOverlayToAdd(sprName, part)
   if overlay then
   if getCore():getDebug() then
      print(tostring(overlay))
   end
      getPlayer():getInventory():Remove(item)
      obj:setOverlaySprite(tostring(overlay), 1,1,1,1)
   end
end
---------------------------

function MoonshineDistillery.isCookingVat(sprName)
   local tab = {
      ["MoonshineDistillery_1"]=true,
      ["MoonshineDistillery_2"]=true,
      ["MoonshineDistillery_3"]=true,
      ["MoonshineDistillery_4"]=true,
      ["MoonshineDistillery_5"]=true,
   }
   return tab[sprName]
end

function MoonshineDistillery.hasCookingVat(sq)
   for i = 0, sq:getObjects():size() - 1 do
      local obj = sq:getObjects():get(i)
      if obj and obj:getSprite() then
         local sprName = obj:getSprite():getName()
         if sprName and MoonshineDistillery.isCookingVat(sprName) then
            return true
         end
      end
   end
   return false
end

function MoonshineDistillery.hasCookingVat(sq)
   for i = 0, sq:getObjects():size() - 1 do
      local obj = sq:getObjects():get(i)
      if obj and obj:getSprite() then
         local sprName = obj:getSprite():getName()
         if sprName and MoonshineDistillery.isCookingVat(sprName) then
            return obj
         end
      end
   end
   return nil
end

---------------------------
function MoonshineDistillery.isCampfire(sprName)
   local tab = {
      ["camping_01_6"]=true,
      ["camping_01_5"]=true,
      ["camping_01_4"]=true,
   }
   return tab[sprName]
end
-----------------------
function MoonshineDistillery.isBoilerTile(sprName)
   local tab = {
      ["MoonshineDistillery_16"] = true,
      ["MoonshineDistillery_27"] = true
   }
   return tab[sprName]
end


function MoonshineDistillery.isCondenserCanTile(sprName)
   local tab = {
      ["MoonshineDistillery_19"] = true,
      ["MoonshineDistillery_24"] = true
   }
   return tab[sprName]
end

function MoonshineDistillery.hasThermometerOverlay(obj)
   if obj:getOverlaySprite() ~= nil then
      local sprName = obj:getOverlaySprite():getName()
      if sprName then
         local tab = {
            ["MoonshineDistillery_21"] = true,
            ["MoonshineDistillery_29"] = true
         }
         return tab[sprName]
      end
   end
   return false
end

function MoonshineDistillery.hasStillCapOverlay(obj)
   if obj:getOverlaySprite() ~= nil then
      local sprName = obj:getOverlaySprite():getName()
      if sprName then
         local tab = {
            ["MoonshineDistillery_20"] = true,
            ["MoonshineDistillery_28"] = true
         }
         return tab[sprName]
      end
   end
   return false
end

function MoonshineDistillery.hasDrainPortOverlay(obj)
   if obj:getOverlaySprite() ~= nil then
      local sprName = obj:getOverlaySprite():getName()
      if sprName then
         local tab = {
            ["MoonshineDistillery_22"] = true,
            ["MoonshineDistillery_30"] = true
         }
         return tab[sprName]
      end
   end
   return false
end

-----------------------            ---------------------------

function MoonshineDistillery.checkDist(pl, sq)
	local x, y = sq:getX(), sq:getY()
	local dist = pl:DistTo(x, y)
   return math.floor(dist) <= 3
end

function MoonshineDistillery.context(player, context, worldobjects, test)
   local pl = getSpecificPlayer(player)
   local inv = pl:getInventory()
   local sq = clickedSquare

   if sq then
      if MoonshineDistillery.CanPlace(pl) then
         local Main = context:addOptionOnTop("Build Moonshine Distiller: ")
         Main.iconTexture = getTexture("media/ui/chop_tree.png")
         local opt = ISContextMenu:getNew(context)
         context:addSubMenu(Main, opt)



         opt:addOption('South', worldobjects, function()
            if not MoonshineDistillery.delBuildItems(pl) then
               pl:setHaloNote(tostring("Failed to build Moonshine Disiller"),250,250,250,900)
               return
            end
            local cursor = ISMoonshineTileCursor:new("MoonshineDistillery_16",  pl, sq)
            getCell():setDrag(cursor, 0)
            ISMoveableCursor.clearCacheForAllPlayers();
         end)

         opt:addOption('East', worldobjects, function()
            if not MoonshineDistillery.delBuildItems(pl) then
               pl:setHaloNote(tostring("Failed to build Moonshine Disiller"),250,250,250,900)
               return
            end
            local cursor = ISMoonshineTileCursor:new("MoonshineDistillery_27",  pl, sq)
            getCell():setDrag(cursor, 0)
            ISMoveableCursor.clearCacheForAllPlayers();
         end)
      end

      for i=0, sq:getObjects():size()-1 do
         local obj = sq:getObjects():get(i)
         local spr = obj:getSprite()
         if spr then
            local sprName = spr:getName()
            if sprName then


               if MoonshineDistillery.isCampfire(sprName) then
                  if MoonshineDistillery.hasMetalDrum(pl) then
                     if MoonshineDistillery.checkDist(pl, sq) then
                        if not MoonshineDistillery.hasCookingVat(sq) then
                           context:addOptionOnTop('Build Cooking Vat', worldobjects, function()
                              local item = MoonshineDistillery.getMetalDrum(pl)
                              if item then
                                 inv:Remove(item)
                                 --obj:setOverlaySprite(tostring("MoonshineDistillery_1"), 1,1,1,1)
                                -- local sq = getPlayer():getSquare();
                                 local sprToSpawn = "MoonshineDistillery_1"
                               --[[   local objToSpawn = IsoThumpable.new(getCell(), sq, sprToSpawn, false, nil);
                                 sq:AddTileObject(objToSpawn);
                    ]]

                                 local props = ISMoveableSpriteProps.new(IsoObject.new(sq, sprToSpawn):getSprite())
                                 props.rawWeight = 10
                                 props:placeMoveableInternal(sq, InventoryItemFactory.CreateItem("Base.Plank"), sprToSpawn)

                                 getPlayerInventory(0):refreshBackpacks()
                                 getPlayerLoot(0):refreshBackpacks()
                                 ISInventoryPage.renderDirty = true


                              end
                           end)
                        end
                     end
                  end
               end


               if MoonshineDistillery.isBoilerTile(sprName) then
                  if MoonshineDistillery.hasThermometer(pl) then
                     if not MoonshineDistillery.hasThermometerOverlay(obj) then
                        context:addOptionOnTop('Add Thermometer', worldobjects, function()
                           local part = "Thermometer"
                           local item = MoonshineDistillery.getThermometer(pl)
                           if item then
                              MoonshineDistillery.addOverlay(obj, sprName, part, item)
                           end
                        end)
                     end
                  end
                  if MoonshineDistillery.hasStillCap(pl) then
                     if not MoonshineDistillery.hasStillCapOverlay(obj) then
                        context:addOptionOnTop('Add Stiil Cap', worldobjects, function()
                           local part = "StillCap"
                           local item = MoonshineDistillery.getStillCap(pl)
                           if item then
                              MoonshineDistillery.addOverlay(obj, sprName, part, item)
                              obj:setIsThumpable(true)
                              obj:setIsContainer(true)
                              obj:setIsDismantable(false)
                              obj:getContainer():setType('Distiller')
                              if isClient() then
                                 obj:transmitCompleteItemToServer()
                                 obj:transmitUpdatedSpriteToClients()
                              end
                              getPlayerInventory(0):refreshBackpacks()
                              getPlayerLoot(0):refreshBackpacks()
                              obj:getContainer():setDrawDirty(true);
                           end
                        end)
                     end
                  end
               elseif MoonshineDistillery.isCondenserCanTile(sprName) then
                  if MoonshineDistillery.hasDrainPort(pl) then
                     if not MoonshineDistillery.hasDrainPortOverlay(obj) then
                        context:addOptionOnTop('Add Drain Port', worldobjects, function()
                           local part = "DrainPort"
                           local item = MoonshineDistillery.getDrainPort(pl)
                           if item then
                              MoonshineDistillery.addOverlay(obj, sprName, part, item)
                           end
                        end)
                     end
                  end
               end
            end
         end
      end
   end
end

Events.OnFillWorldObjectContextMenu.Remove(MoonshineDistillery.context)
Events.OnFillWorldObjectContextMenu.Add(MoonshineDistillery.context)

-----------------------            ---------------------------

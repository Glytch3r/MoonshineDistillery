--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													                   |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							                |
|                       		                                    														 	                   |
|                       	Discord:    Glytch3r#1337 / glytch3r															                      |
|                       		                                    													                  	 	 |
|                       	Support:    https://ko-fi.com/glytch3r														                      	 |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


MoonshineDistillery = MoonshineDistillery or {}


-----------------------            ---------------------------
function MoonshineDistillery.CanPlace(pl)
   local inv = pl:getInventory()
   return inv:contains("MoonDist.Boiler") and inv:contains("MoonDist.Thumper")-- and inv:contains("MetalDrum")
end
-----------------------
function MoonshineDistillery.hasThermometerItem(pl)
   local inv = pl:getInventory()
   return inv:contains("MoonDist.Thermometer")
end
function MoonshineDistillery.hasDrainPortItem(pl)
   local inv = pl:getInventory()
   return inv:contains("MoonDist.DrainPort")
end
function MoonshineDistillery.hasStillCapItem(pl)
   local inv = pl:getInventory()
   return inv:contains("MoonDist.StillCap")
end

-----------------------
function MoonshineDistillery.hasMetalDrumItem(pl)
   local inv = pl:getInventory()
   return inv:contains("Base.MetalDrum") or inv:contains("Moveables.industry_01_22") or inv:contains("Moveables.industry_01_23")
end
-----------------------            ---------------------------
function MoonshineDistillery.getThermometer(pl)
   local inv = pl:getInventory()
   return inv:FindAndReturn("MoonDist.Thermometer")
end
function MoonshineDistillery.getDrainPort(pl)
   local inv = pl:getInventory()
   return inv:FindAndReturn("MoonDist.DrainPort")
end
function MoonshineDistillery.getStillCapItem(pl)
   local inv = pl:getInventory()
   return inv:FindAndReturn("MoonDist.StillCap")
end


function MoonshineDistillery.delBuildItems(pl)
   local inv = pl:getInventory()
   local delCount = 0
   local item1 = inv:FindAndReturn("MoonDist.Thumper")
   if item1 then
      inv:Remove(item1)
      delCount = delCount + 1
   end
   local item2 = inv:FindAndReturn("MoonDist.Boiler")
   if item2 then
      inv:Remove(item2)
      delCount = delCount + 1
   end
   getPlayerInventory(0):refreshBackpacks()
   getPlayerLoot(0):refreshBackpacks()
   if delCount == 2 then
      return true
   end
   return false
end

-----------------------
function MoonshineDistillery.getMetalDrumItem(pl)
   local inv = pl:getInventory()
   return inv:FindAndReturn("MetalDrum") or inv:FindAndReturn("Moveables.industry_01_22") or inv:FindAndReturn("Moveables.industry_01_23")
end
-----------------------            ---------------------------
MoonshineDistillery.addParts = {
   ["MoonshineDistillery_16"] = {["StillCap"] = "MoonshineDistillery_20", ["Thermometer"] = "MoonshineDistillery_21"},
   ["MoonshineDistillery_27"] = {["StillCap"] = "MoonshineDistillery_28", ["Thermometer"] = "MoonshineDistillery_29"},
   ["MoonshineDistillery_19"] = {["DrainPort"]= "MoonshineDistillery_22"},
   ["MoonshineDistillery_24"] = {["DrainPort"]= "MoonshineDistillery_30"},
}

function MoonshineDistillery.getOverlayToAdd(sprName, part)
   return MoonshineDistillery.addParts[sprName][part]
end
function MoonshineDistillery.addOverlay(obj, sprName, part, item)
   if not (obj or sprName) then return end
   local overlay = MoonshineDistillery.getOverlayToAdd(sprName, part)
   if overlay then
   if getCore():getDebug() then
      print(tostring(overlay))
   end
      getPlayer():getInventory():Remove(item)
      obj:setOverlaySprite(tostring(overlay), 1,1,1,1)
   end
end
---------------------------

---------------------------
function MoonshineDistillery.isBoilerTile(sprName)
   local tab = {
      ["MoonshineDistillery_16"] = true,
      ["MoonshineDistillery_27"] = true
   }
   return tab[sprName]
end

function MoonshineDistillery.isStillCap(sprName)
   local tab = {
      ["MoonshineDistillery_20"] = true,
      ["MoonshineDistillery_28"] = true
   }
   return tab[sprName]
end
function MoonshineDistillery.isThermometer(sprName)
   local tab = {
      ["MoonshineDistillery_21"] = true,
      ["MoonshineDistillery_29"] = true
   }
   return tab[sprName]
end
function MoonshineDistillery.isCondenserCanTile(sprName)
   local tab = {
      ["MoonshineDistillery_19"] = true,
      ["MoonshineDistillery_24"] = true
   }
   return tab[sprName]
end
function MoonshineDistillery.isDrainPort(sprName)
   local tab = {
      ["MoonshineDistillery_22"] = true,
      ["MoonshineDistillery_30"] = true
   }
   return tab[sprName]
end
-----------------------            ---------------------------
function MoonshineDistillery.hasThermometerOverlay(obj)
   if obj:getOverlaySprite() ~= nil then
      local sprName = obj:getOverlaySprite():getName()
      if sprName then
         local tab = {
            ["MoonshineDistillery_21"] = true,
            ["MoonshineDistillery_29"] = true
         }
         return tab[sprName]
      end
   else
      local sq = obj:getSquare()
      for i = 0, sq:getObjects():size() - 1 do
         local obj2 = sq:getObjects():get(i)
         if obj2:getSprite() and  MoonshineDistillery.isThermometer(obj2:getSprite():getName()) then
               return true
         end
      end
   end
   return false
end

function MoonshineDistillery.hasStillCapOverlay(obj)
   if obj:getOverlaySprite() ~= nil then
      local sprName = obj:getOverlaySprite():getName()
      if sprName then
         local tab = {
            ["MoonshineDistillery_20"] = true,
            ["MoonshineDistillery_28"] = true
         }
         return tab[sprName]
      end
   else
      local sq = obj:getSquare()
      for i = 0, sq:getObjects():size() - 1 do
         local obj2 = sq:getObjects():get(i)
         if obj2:getSprite() and  MoonshineDistillery.isStillCap(obj2:getSprite():getName()) then
               return true
         end
      end
   end
   return false
end

function MoonshineDistillery.getStillCapObj(obj)
   local sq = obj:getSquare()
   if not obj or not sq then return nil end
   for i = 0, sq:getObjects():size() - 1 do
      local obj2 = sq:getObjects():get(i)
      if obj2:getSprite() and  MoonshineDistillery.isStillCap(obj2:getSprite():getName()) then
         return obj2
      end
   end
   return nil
end

function MoonshineDistillery.hasDrainPortOverlay(sq2)

    if not sq2 then return false end

    for i = 0, sq2:getObjects():size() - 1 do
        local obj = sq2:getObjects():get(i)
        if obj:getSprite() and MoonshineDistillery.isDrainPort(obj:getSprite():getName()) then
            return true
        end
    end
    return false
end


MoonshineDistillery.FacePart = {
    ["MoonshineDistillery_16"] = "MoonshineDistillery_22",
    ["MoonshineDistillery_27"] = "MoonshineDistillery_30",
    ["MoonshineDistillery_22"] = "MoonshineDistillery_16",
    ["MoonshineDistillery_30"] = "MoonshineDistillery_27",
}
function MoonshineDistillery.getDrainPortSquare(x, y, z, sprName)
    if sprName == "MoonshineDistillery_16" then
        x = x + 1
        y = y - 1
    elseif sprName == "MoonshineDistillery_27" then
        x = x - 1
        y = y + 1
    else
        return nil
    end
    return getCell():getGridSquare(x, y, z)
end


function MoonshineDistillery.hasDrainPort(x, y, z, sprName)
    local sq = MoonshineDistillery.getDrainPortSquare(x, y, z, sprName)
    if not sq then return false end

    local drainportSprite = MoonshineDistillery.FacePart[sprName]
    for i = 0, sq:getObjects():size() - 1 do
        local obj = sq:getObjects():get(i)
        if obj:getSprite() and obj:getSprite():getName() == drainportSprite then
            return true
        end
    end
    return false
end
function MoonshineDistillery.setDrainPort(sq2, sprName)
   if not sq2 then return end

   local sprToSpawn = MoonshineDistillery.FacePart[sprName]
   if not sprToSpawn then return end
   print(sprToSpawn)
   local toSpawn = IsoThumpable.new(getCell(), sq2, sprToSpawn, false, nil);
   sq2:AddTileObject(toSpawn);
   toSpawn:setIsThumpable(true)
   toSpawn:setIsContainer(true)
   toSpawn:setIsDismantable(false)

   local cont = toSpawn:getContainer()
   cont:setType('DrainPort')
   cont:setDrawDirty(true);
   local yieldData = toSpawn:getModData()

   yieldData['Yield'] = {
      ["Clear"]=0,
      ["Apple"]=0,
      ["Peach"]=0,
   }
   toSpawn:transmitModData()
   ISInventoryPage.renderDirty = true
   if isClient() then
      toSpawn:transmitCompleteItemToServer()
      toSpawn:transmitUpdatedSpriteToClients()
   end
   getPlayerInventory(0):refreshBackpacks()
   getPlayerLoot(0):refreshBackpacks()

end



-----------------------            ---------------------------

function MoonshineDistillery.checkDist(pl, sq)
   pl = pl or getPlayer()
	local x, y = sq:getX(), sq:getY()
	local dist = pl:DistTo(x, y)
   return math.floor(dist) <= 3
end
function MoonshineDistillery.delInvItem(item, inv)
   local bool = false

   if item and inv then
      inv:Remove(item)
      bool = true
   end
   getPlayerInventory(0):refreshBackpacks()
   getPlayerLoot(0):refreshBackpacks()
   ISInventoryPage.renderDirty = true
   return bool
end
function MoonshineDistillery.spawnPart(sprToSpawn, sq, item, inv)
   local props = ISMoveableSpriteProps.new(IsoObject.new(sq, sprToSpawn):getSprite())
   props.rawWeight = 10
   local obj = props:placeMoveableInternal(sq, InventoryItemFactory.CreateItem("Base.Plank"), sprToSpawn)
   MoonshineDistillery.delInvItem(item, inv)
   return obj
end
function MoonshineDistillery.isLearned(pl)
    local recipe = "Build Moonshine Distiller"
    pl = pl or getPlayer()
    return pl:getKnownRecipes():contains(recipe) or pl:isRecipeKnown(recipe)
end
function MoonshineDistillery.delContItem(itemType, cont)
   local bool = false
   if cont then
      for i=1, cont:getItems():size() do
         local item = cont:getItems():get(i-1)
         local type = item:getType()
         if type == itemType then
            if isClient() then cont:removeItemOnServer(item) end
            cont:DoRemoveItem(item)
            bool = true
            break
         end
      end
   end
   getPlayerInventory(0):refreshBackpacks()
   getPlayerLoot(0):refreshBackpacks()
   ISInventoryPage.renderDirty = true
   return bool
end

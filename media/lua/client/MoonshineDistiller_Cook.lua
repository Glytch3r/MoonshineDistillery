--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													                   |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							                |
|                       		                                    														 	                   |
|                       	Discord:    Glytch3r#1337 / glytch3r															                      |
|                       		                                    													                  	 	 |
|                       	Support:    https://ko-fi.com/glytch3r														                      	 |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

MoonshineDistillery = MoonshineDistillery or {}


function MoonshineDistillery.isCampfire(obj)
   if obj:getName() == "Campfire" then return true end
   local spr = obj:getSprite()
   local sprName = spr and spr:getName()
   if not sprName then return false  end
   local tab = {
      ["camping_01_6"]=true,
      ["camping_01_5"]=true,
      ["camping_01_4"]=true,
   }
   return tab[sprName] or false
end



function MoonshineDistillery.getCampfire(sq)
   for i = 0, sq:getObjects():size() - 1 do
      local obj = sq:getObjects():get(i)
      if MoonshineDistillery.isCampfire(obj) then
         return obj
      end
   end
   return nil
end

function MoonshineDistillery.hasCampfire(sq)
   return MoonshineDistillery.getCampfire(sq) ~= nil
end
function MoonshineDistillery.hasLitCampfire(sq)
   local campfire = MoonshineDistillery.getCampfire(sq)

   local isLit = campfire and campfire:getModData().isLit
   local fuelAmt = campfire and campfire:getModData().fuelAmt

   return isLit and fuelAmt > 0
end
-----------------------

function MoonshineDistillery.isCookingVat(sprName)
   local tab = {
      ["MoonshineDistillery_0"]=true,
      ["MoonshineDistillery_1"]=true,
      ["MoonshineDistillery_2"]=true,
      ["MoonshineDistillery_3"]=true,
      ["MoonshineDistillery_4"]=true,
   }
   return tab[sprName]
end

function MoonshineDistillery.hasCookingVat(sq)
   for i = 0, sq:getObjects():size() - 1 do
      local obj = sq:getObjects():get(i)
      if obj and obj:getSprite() then
         local sprName = obj:getSprite():getName()
         if sprName and MoonshineDistillery.isCookingVat(sprName) then
            return true
         end
      end
   end
   return false
end

function MoonshineDistillery.getCookingVat(sq)
   for i = 0, sq:getObjects():size() - 1 do
      local obj = sq:getObjects():get(i)
      if obj and obj:getSprite() then
         local sprName = obj:getSprite():getName()
         if sprName and MoonshineDistillery.isCookingVat(sprName) then
            return obj
         end
      end
   end
   return nil
end




function MoonshineDistillery.getStage(sprName)
    local tab = {
        ["MoonshineDistillery_0"] = "empty",
        ["MoonshineDistillery_1"] = "water",
        ["MoonshineDistillery_2"] = "mash",
        ["MoonshineDistillery_3"] = "unfermented",
        ["MoonshineDistillery_4"] = "cooking",
    }
    return tab[sprName]
end



function MoonshineDistillery.setStage(obj, stage)
    local tab = {
      ["empty"] =  "MoonshineDistillery_0",
      ["water"] =  "MoonshineDistillery_1",
      ["mash"] =  "MoonshineDistillery_2",
      ["unfermented"] = "MoonshineDistillery_3",
      ["cooking"] =  "MoonshineDistillery_4",
    }
   local nextStage =  tab[stage]
   if stage == "empty" then
      obj:getModData()['timestamp'] = nil
      obj:getModData()['Flavor'] = nil
   end
   obj:getModData()['stage'] = nextStage
   obj:setSpriteFromName(nextStage)
   obj:getSprite():setName(nextStage)
   obj:setOverlaySprite(nextStage, true)
   obj:transmitUpdatedSpriteToServer();

   obj:transmitModData()
   ISInventoryPage.renderDirty = true
   getPlayerInventory(0):refreshBackpacks()
   getPlayerLoot(0):refreshBackpacks()


end
-----------------------            ---------------------------

function MoonshineDistillery.doCook(cookingVat, pl)
   if not cookingVat then return end
   local spr = cookingVat:getSprite()
   if not spr then return end
   local sprName = spr:getName()
   if not sprName then return end

   local cookData = cookingVat:getModData()
   local cookingvatCont = cookingVat:getContainer()
   if not cookingvatCont then return end
   local sq = cookingVat:getSquare()
   if not sq then return end

   local isLit = MoonshineDistillery.hasLitCampfire(sq)
--[[
   local isClosestPl = MoonshineDistillery.isClosestPl(pl, sq)
   if not isClosestPl then return end

 ]]
   local overlay = cookingVat:getOverlaySprite()
   local overlayName = overlay:getName()
   local stage = MoonshineDistillery.getStage(overlayName) or  MoonshineDistillery.getStage(sprName) or cookData['stage']
   if not stage then return end
   local isCooking = cookData['timestamp'] ~= nil and cookData['Flavor'] ~= nil and stage == "cooking"

   if stage == "empty" then
      local item = cookingvatCont:FindAndReturn("Base.BucketWaterFull")
      if item then
         if isClient() then cookingvatCont:removeItemOnServer(item) end
         cookingvatCont:DoRemoveItem(item)
         ISInventoryPage.dirtyUI();
         MoonshineDistillery.setStage(cookingVat, "water")
      end

      if MoonshineDistillery.getUnfermentedBucket(cookingvatCont) ~= nil then
         MoonshineDistillery.setStage(cookingVat, "unfermented")
      elseif MoonshineDistillery.getMashBucket(cookingvatCont) ~= nil then
         MoonshineDistillery.setStage(cookingVat, "mash")
      end


   end
   if stage == "water" then
      if not isCooking and isLit then
         local flavorMap = {
            ["MoonDist.MoonshineMashBaseClear"] = "Clear",
            ["MoonDist.MoonshineMashBaseApple"] = "Apple",
            ["MoonDist.MoonshineMashBasePeach"] = "Peach"
         }
         for itemType, flavor in pairs(flavorMap) do
            local item = cookingvatCont:FindAndReturn(itemType)
            if item then
               cookingVat:getModData()['timestamp'] = getGameTime():getWorldAgeHours()
               cookingVat:getModData()['Flavor'] = flavor
               if isClient() then cookingvatCont:removeItemOnServer(item) end
               cookingvatCont:DoRemoveItem(item)
               cookingVat:transmitModData()
               ISInventoryPage.dirtyUI();
               pl:setHaloNote("Cooking Vat set "..tostring(flavor),150,250,150,900)
               MoonshineDistillery.setStage(cookingVat, "cooking")
               break
            end
         end
      end
   end
   if stage == "cooking" then
      cookingVat:setHighlighted(isLit, false)
      cookingVat:setHighlightColor(1, 0, 0, 0.8)
      local timeleft = MoonshineDistillery.getRemainingCookMins(cookingVat)
      if timeleft then
         if isLit and timeleft <= 0 then
            local toSpawn = "MoonDist.BucketMoonshineMash" .. cookData['Flavor']
            if toSpawn then
               cookingvatCont:AddItem(toSpawn)
               ISInventoryPage.dirtyUI();
               getSoundManager():PlayWorldSound('MoonshineSlosh', sq, 0, 5, 5, false)
               cookingVat:setHighlighted(false, false)

               MoonshineDistillery.setStage(cookingVat, "mash")
            end
         elseif not (isLit and timeleft > 0) then
            cookingVat:getModData()['timestamp'] = nil
            local flav = cookingVat:getModData()['Flavor']
            if flav then
               local toReturn = {
                  ["Clear"] = "MoonDist.MoonshineMashBaseClear",
                  ["Apple"] = "MoonDist.MoonshineMashBaseApple",
                  ["Peach"] = "MoonDist.MoonshineMashBasePeach",
               }

               cookingvatCont:AddItem(toReturn[flav])
               ISInventoryPage.dirtyUI()
               cookingVat:getModData()['Flavor'] = nil
               MoonshineDistillery.setStage(cookingVat, "water")
            else
               MoonshineDistillery.setStage(cookingVat, "empty")
            end
         end
      end

   end
   if stage == "mash" then
      if MoonshineDistillery.getMashBucket(cookingvatCont) == nil then
         cookingVat:setCustomColor(ColorInfo.new(1, 0, 0, 0.5))
         cookingVat:transmitCustomColor()
      else
         cookingVat:setCustomColor(ColorInfo.new(1, 1, 1, 1))
         cookingVat:transmitCustomColor()
      end
   end
   if stage == "unfermented" then
      if MoonshineDistillery.getUnfermentedBucket(cookingvatCont) == nil then
         MoonshineDistillery.setStage(cookingVat, "empty")
      end
   end
end
-----------------------            ---------------------------
--[[
   local campfire = CCampfireSystem.instance:getLuaObjectOnSquare(sq)
   if not campfire then return end
 ]]

function MoonshineDistillery.CookTimer()
   local vats = MoonshineDistillery.findCookingVats()
   if not vats or #vats == 0 then return end
   local pl = getPlayer()
   if not pl then return end
   for _, cookingVat in ipairs(vats) do
      local sprName = MoonshineDistillery.getSprName(cookingVat)
      local stage = MoonshineDistillery.getStage(sprName)
      local cookData = cookingVat:getModData()
      if cookData and stage and sprName then
         if cookData['stage'] ~= nil then
            if cookData['stage'] ~= stage then
               MoonshineDistillery.setStage(cookingVat, tostring(cookData['stage']))
            end
         end
      end
      MoonshineDistillery.doCook(cookingVat, pl)
   end
end
Events.EveryOneMinute.Remove(MoonshineDistillery.CookTimer)
Events.EveryOneMinute.Add(MoonshineDistillery.CookTimer)
